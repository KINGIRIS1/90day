# âœ… Gemini Flash - Complete 98 Document Types Integration

## ğŸ“… NgÃ y cáº­p nháº­t
**December 2024**

## ğŸ¯ Objective
Cáº­p nháº­t Gemini Flash prompt Ä‘á»ƒ bao gá»“m **TOÃ€N Bá»˜ 98 loáº¡i tÃ i liá»‡u** vá»›i format dá»… Ä‘á»c, Ä‘Æ°á»£c chia thÃ nh 12 nhÃ³m logic.

---

## ğŸ“Š BEFORE vs AFTER

### **Before:**
- âŒ Chá»‰ liá»‡t kÃª ~20 loáº¡i tÃ i liá»‡u phá»• biáº¿n nháº¥t
- âŒ KhÃ´ng cÃ³ nhÃ³m phÃ¢n loáº¡i
- âŒ Thiáº¿u nhiá»u loáº¡i tÃ i liá»‡u quan trá»ng
- âŒ Format khÃ³ Ä‘á»c (danh sÃ¡ch dÃ i khÃ´ng cÃ³ cáº¥u trÃºc)

### **After:**
- âœ… **Äáº§y Ä‘á»§ 98 loáº¡i tÃ i liá»‡u**
- âœ… **Chia thÃ nh 12 nhÃ³m logic** vá»›i emoji
- âœ… **Highlight cÃ¡c cáº·p dá»… nháº§m** (âš ï¸ Dá»„ NHáº¦M)
- âœ… **Format dá»… Ä‘á»c** (theo nhÃ³m chá»©c nÄƒng)
- âœ… **Consistency vá»›i rule_classifier.py** (EXACT_TITLE_MAPPING)

---

## ğŸ“‹ 12 NHÃ“M TÃ€I LIá»†U

### **NhÃ³m 1: Báº¢N Váº¼ / Báº¢N Äá»’** (5 loáº¡i)
```
BMT, HSKT, BVHC, BVN, SDTT
```
**Äáº·c Ä‘iá»ƒm:** TÃ i liá»‡u ká»¹ thuáº­t, báº£n váº½ Ä‘á»‹a chÃ­nh

### **NhÃ³m 2: Báº¢NG KÃŠ / DANH SÃCH** (4 loáº¡i)
```
BKKDT, DSCG, DS15, DSCK
```
**Äáº·c Ä‘iá»ƒm:** Báº£ng liá»‡t kÃª, danh sÃ¡ch thá»‘ng kÃª

### **NhÃ³m 3: BIÃŠN Báº¢N** (10 loáº¡i)
```
BBBDG, BBGD, BBHDDK, BBNT, BBKTSS, BBKTHT, BBKTDC, KTCKCG, KTCKMG, BLTT
```
**Äáº·c Ä‘iá»ƒm:** BiÃªn báº£n xÃ¡c nháº­n, ghi nháº­n sá»± kiá»‡n

### **NhÃ³m 4: GIáº¤Y Tá»œ CÃ NHÃ‚N** (4 loáº¡i)
```
CCCD, GKS, GKH, DICHUC
```
**Äáº·c Ä‘iá»ƒm:** Giáº¥y tá» Ä‘á»‹nh danh, há»“ sÆ¡ cÃ¡ nhÃ¢n

### **NhÃ³m 5: GIáº¤Y CHá»¨NG NHáº¬N** (9 loáº¡i)
```
GCNM, GCNC, GXNNVTC, GNT, GSND, GTLQ, GUQ, GXNDKLD, GPXD
```
**Äáº·c Ä‘iá»ƒm:** Giáº¥y chá»©ng nháº­n quyá»n, xÃ¡c nháº­n

### **NhÃ³m 6: Há»¢P Äá»’NG** âš ï¸ Dá»„ NHáº¦M (7 loáº¡i)
```
HDCQ, HDUQ, HDTHC, HDTD, HDTCO, HDBDG, hoadon
```
**Äáº·c Ä‘iá»ƒm:** Há»£p Ä‘á»“ng giao dá»‹ch (PHáº¢I phÃ¢n biá»‡t tá»« khÃ³a)
- HDCQ: "CHUYá»‚N NHÆ¯á»¢NG"
- HDUQ: "á»¦Y QUYá»€N"
- HDTHC: "THáº¾ CHáº¤P"
- HDTD: "THUÃŠ Äáº¤T"

### **NhÃ³m 7: ÄÆ N** âš ï¸ Dá»„ NHáº¦M (15 loáº¡i)
```
DDKBD, DDK, DCK, CHTGD, DCQDGD, DMG, DMD, DXN, DXCMD, DGH, DXGD, DXTHT, DXCD, DDCTH, DXNTH
```
**Äáº·c Ä‘iá»ƒm:** ÄÆ¡n Ä‘á» nghá»‹, Ä‘Æ¡n xin phÃ©p
- DDKBD: cÃ³ "BIáº¾N Äá»˜NG"
- DDK: khÃ´ng cÃ³ "BIáº¾N Äá»˜NG"

### **NhÃ³m 8: QUYáº¾T Äá»ŠNH** âš ï¸ Dá»„ NHáº¦M (15 loáº¡i)
```
QDGTD, QDCMD, QDTH, QDGH, QDTT, QDCHTGD, QDDCGD, QDDCTH, QDHG, QDPDBT, QDDCQH, QDPDDG, QDTHA, QDHTSD, QDXP
```
**Äáº·c Ä‘iá»ƒm:** Quyáº¿t Ä‘á»‹nh hÃ nh chÃ­nh (PHáº¢I cÃ³ tá»« khÃ³a cá»¥ thá»ƒ)
- QDGTD: "GIAO Äáº¤T"
- QDCMD: "CHO PHÃ‰P CHUYá»‚N Má»¤C ÄÃCH"
- QDTH: "THU Há»’I"
- QDGH: "GIA Háº N"

### **NhÃ³m 9: PHIáº¾U** (8 loáº¡i)
```
PCT, PKTHS, PLYKDC, PXNKQDD, DKTC, DKTD, DKXTC, QR
```
**Äáº·c Ä‘iá»ƒm:** Phiáº¿u yÃªu cáº§u, phiáº¿u xÃ¡c nháº­n

### **NhÃ³m 10: THÃ”NG BÃO** (8 loáº¡i)
```
TBT, TBMG, TBCKCG, TBCKMG, HTNVTC, TBCNBD, CKDC, HTBTH
```
**Äáº·c Ä‘iá»ƒm:** ThÃ´ng bÃ¡o hÃ nh chÃ­nh, xÃ¡c nháº­n

### **NhÃ³m 11: Tá»œ KHAI / Tá»œ TRÃŒNH** (3 loáº¡i)
```
TKT, TTr, TTCG
```
**Äáº·c Ä‘iá»ƒm:** Tá» khai thuáº¿, tá» trÃ¬nh Ä‘á» xuáº¥t

### **NhÃ³m 12: VÄ‚N Báº¢N** (10 loáº¡i)
```
CKTSR, VBCTCMD, VBDNCT, PDPASDD, VBTK, TTHGD, CDLK, HCLK, VBTC, PCTSVC
```
**Äáº·c Ä‘iá»ƒm:** VÄƒn báº£n thá»a thuáº­n, cam káº¿t

---

## ğŸ¯ CÃC Cáº¶P Dá»„ NHáº¦M - HIGHLIGHTED

### **1. Há»¢P Äá»’NG (Contract Types)**

```
Priority Order (Check in this sequence):

1. HDCQ - "CHUYá»‚N NHÆ¯á»¢NG"
   â†“ (if not found)
2. HDUQ - "á»¦Y QUYá»€N"
   â†“ (if not found)
3. HDTHC - "THáº¾ CHáº¤P"
   â†“ (if not found)
4. HDTD - "THUÃŠ"
   â†“ (if not found)
5. HDTCO - "THI CÃ”NG"
   â†“ (if not found)
6. HDBDG - "MUA BÃN"
   â†“ (if none found)
7. UNKNOWN
```

**LÃ½ do:** Náº¿u title cÃ³ "Há»¢P Äá»’NG CHUYá»‚N NHÆ¯á»¢NG QUYá»€N Sá»¬ Dá»¤NG Äáº¤T"
- Contains both "CHUYá»‚N NHÆ¯á»¢NG" and "QUYá»€N" (might confuse with á»¦Y QUYá»€N)
- **Solution:** Check HDCQ FIRST â†’ Match â†’ Return HDCQ âœ…

### **2. ÄÆ N ÄÄ‚NG KÃ (Application Types)**

```
DDKBD vs DDK:

Title: "ÄÆ N ÄÄ‚NG KÃ [???] Äáº¤T ÄAI"
         â†“
    Check [???]
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚
"BIáº¾N Äá»˜NG"    (empty)
    â†“              â†“
  DDKBD          DDK
```

**Critical:** Must have explicit "BIáº¾N Äá»˜NG" keyword â†’ DDKBD
Without it â†’ DDK

### **3. GIáº¤Y vs Há»¢P Äá»’NG á»¦Y QUYá»€N**

```
GUQ vs HDUQ:

"GIáº¤Y á»¦Y QUYá»€N" â†’ GUQ (standalone authorization letter)
"Há»¢P Äá»’NG á»¦Y QUYá»€N" â†’ HDUQ (contract-based authorization)

MUST distinguish by checking for "Há»¢P Äá»’NG" prefix!
```

### **4. QUYáº¾T Äá»ŠNH (Decision Types)**

```
All start with "QUYáº¾T Äá»ŠNH" â†’ Must check next keyword:

QUYáº¾T Äá»ŠNH + ?
    â†“
    â”œâ”€ "GIAO Äáº¤T" â†’ QDGTD
    â”œâ”€ "CHO PHÃ‰P" â†’ QDCMD
    â”œâ”€ "THU Há»’I" â†’ QDTH
    â”œâ”€ "GIA Háº N" â†’ QDGH
    â”œâ”€ "TÃCH, Há»¢P" â†’ QDTT
    â””â”€ (other) â†’ Check full list
```

### **5. GCNM vs GCNC**

```
Title: "GIáº¤Y CHá»¨NG NHáº¬N QUYá»€N Sá»¬ Dá»¤NG Äáº¤T [???]"
                                          â†“
                                    Check [???]
                                          â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                           â”‚
        "QUYá»€N Sá» Há»®U TÃ€I Sáº¢N Gáº®N LIá»€N Vá»šI Äáº¤T"              (empty)
                    â†“                                           â†“
                  GCNM                                        GCNC
            (New format, full)                        (Old format, short)
```

---

## ğŸ“ PROMPT STRUCTURE

### **Section 1: Safety & Context** (Lines 1-25)
- Safety warning (ignore personal photos)
- Quá»‘c huy priority
- 2-page horizontal document handling

### **Section 2: Strict Rules** (Lines 26-50)
- 100% exact matching requirement
- No guessing policy
- Multi-page awareness
- UNKNOWN threshold

### **Section 3: Easy-to-Confuse Pairs** (Lines 51-80)
- 5 detailed confusing pairs
- Decision trees for each
- Priority order for checking

### **Section 4: Complete Document List** (Lines 81-230)
- **12 groups** with emoji headers
- **98 document types** with full Vietnamese titles
- Short codes clearly mapped
- âš ï¸ markers for confusing groups

### **Section 5: Process & Output** (Lines 231-250)
- Step-by-step verification process
- JSON output format
- Final reminders

---

## ğŸ¨ FORMAT IMPROVEMENTS

### **Before:**
```
Báº¢N MÃ” Táº¢ RANH GIá»šI, Má»C GIá»šI THá»¬A Äáº¤T â†’ BMT
Báº¢N Váº¼ (TRÃCH Lá»¤C, ÄO TÃCH, CHá»ˆNH LÃ) â†’ HSKT
GIáº¤Y CHá»¨NG NHáº¬N QUYá»€N Sá»¬ Dá»¤NG Äáº¤T â†’ GCNC
Há»¢P Äá»’NG CHUYá»‚N NHÆ¯á»¢NG â†’ HDCQ
...
(84 more mixed together without structure)
```

### **After:**
```
ğŸ“‹ NHÃ“M 1: Báº¢N Váº¼ / Báº¢N Äá»’ (5 loáº¡i)
Báº¢N MÃ” Táº¢ RANH GIá»šI, Má»C GIá»šI THá»¬A Äáº¤T â†’ BMT
Báº¢N Váº¼ (TRÃCH Lá»¤C, ÄO TÃCH, CHá»ˆNH LÃ) â†’ HSKT
...

ğŸ“‹ NHÃ“M 5: GIáº¤Y CHá»¨NG NHáº¬N (9 loáº¡i)
GIáº¤Y CHá»¨NG NHáº¬N QUYá»€N Sá»¬ Dá»¤NG Äáº¤T â†’ GCNC
...

ğŸ“‹ NHÃ“M 6: Há»¢P Äá»’NG (7 loáº¡i) âš ï¸ Dá»„ NHáº¦M
Há»¢P Äá»’NG CHUYá»‚N NHÆ¯á»¢NG, Táº¶NG CHO QUYá»€N Sá»¬ Dá»¤NG Äáº¤T â†’ HDCQ
Há»¢P Äá»’NG á»¦Y QUYá»€N â†’ HDUQ
...
```

**Benefits:**
- âœ… Easier for AI to scan by category
- âœ… Visual separation with emoji headers
- âœ… Warning markers for confusing groups
- âœ… Logical grouping helps pattern recognition

---

## ğŸ“Š COMPARISON WITH RULE_CLASSIFIER.PY

| Aspect | rule_classifier.py | Gemini Flash Prompt |
|--------|-------------------|---------------------|
| **Total Types** | 98 | 98 âœ… |
| **Exact Titles** | EXACT_TITLE_MAPPING | Full list âœ… |
| **Grouping** | No grouping | 12 groups âœ… |
| **Confusing Pairs** | Handled in code | Explicitly listed âœ… |
| **Format** | Python dict | Structured text âœ… |
| **Consistency** | Source of truth | 100% aligned âœ… |

---

## ğŸš€ EXPECTED IMPROVEMENTS

### **Accuracy:**
- âœ… Better recognition of rare document types
- âœ… Fewer "UNKNOWN" for valid documents
- âœ… More accurate handling of confusing pairs

### **Coverage:**
- âœ… All 98 types now explicitly known to AI
- âœ… No more "I don't see this type in the list"
- âœ… Complete Vietnamese title â†’ Code mapping

### **Consistency:**
- âœ… 100% alignment with rule-based classifier
- âœ… Same results as OpenAI Vision (same prompt structure)
- âœ… Predictable behavior across all document types

---

## ğŸ§ª TESTING RECOMMENDATIONS

### **Test with each group:**

1. **NhÃ³m 1-5:** Test 1-2 samples from each
2. **NhÃ³m 6 (Há»¢P Äá»’NG):** Test ALL types (easy to confuse)
3. **NhÃ³m 7 (ÄÆ N):** Focus on DDKBD vs DDK
4. **NhÃ³m 8 (QUYáº¾T Äá»ŠNH):** Test 3-4 common types
5. **NhÃ³m 9-12:** Spot check 1-2 per group

### **Confusing pairs test:**
- [ ] HDCQ vs HDUQ with ambiguous titles
- [ ] DDKBD vs DDK with/without "biáº¿n Ä‘á»™ng"
- [ ] GUQ vs HDUQ
- [ ] QDGTD vs QDCMD vs QDTH
- [ ] GCNM vs GCNC

### **Edge cases:**
- [ ] Document with no title (should return UNKNOWN)
- [ ] Document with partial title (should return UNKNOWN)
- [ ] 2-page horizontal GCNC
- [ ] Document with both "chuyá»ƒn nhÆ°á»£ng" and "á»§y quyá»n"

---

## ğŸ“š RELATED FILES

### **Updated:**
- `python/ocr_engine_gemini_flash.py` - Prompt updated

### **Reference:**
- `python/rule_classifier.py` - EXACT_TITLE_MAPPING (source of truth)
- `backend/server.py` - OpenAI Vision prompt (alignment reference)

### **Documentation:**
- `GEMINI_OPENAI_ALIGNMENT.md` - Prompt alignment
- `DOCUMENT_RECOGNITION_DETAILS.md` - Complete system overview
- `RECOGNITION_VISUAL_FLOW.md` - Visual diagrams

---

## âœ… STATUS

**COMPLETE** âœ…

**Changes:**
- âœ… Prompt updated with all 98 types
- âœ… Grouped into 12 logical categories
- âœ… Confusing pairs highlighted
- âœ… Format improved for readability
- âœ… 100% aligned with rule_classifier.py

**Ready for:**
- User testing with real documents
- Accuracy comparison with rule-based classifier
- Production deployment

---

## ğŸ’¡ FUTURE ENHANCEMENTS

1. **Dynamic Prompt Generation**
   - Load EXACT_TITLE_MAPPING from file
   - Auto-generate grouped list
   - Keep prompt in sync with rule updates

2. **Prompt Optimization**
   - A/B test different groupings
   - Test shorter vs longer descriptions
   - Optimize for Gemini Flash specifically

3. **Localization**
   - Test with different Vietnamese regional variations
   - Handle OCR errors in title recognition

---

**Summary:**
Gemini Flash prompt now includes **complete 98-document-type coverage** with structured format, grouped into 12 categories, and explicit handling of confusing pairs. 100% aligned with rule_classifier.py for consistency.
