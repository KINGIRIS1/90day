<analysis>
The trajectory details the AI engineer's work on a desktop OCR application, focusing on stabilizing the Windows Electron build and integrating Gemini Flash AI. Initially, the core challenge was addressing persistent Python dependency issues (, ) in production  builds that worked flawlessly in development mode. This led to extensive debugging of  configurations,  settings, and  management within .

The conversation then shifted to implementing user requirements: an all-in-one NSIS installer, dynamic system Python detection, robust Gemini Flash integration with API key management, and specific app metadata. This involved iterative fixes for build failures (,  path issues,  syntax), UI display problems (missing app logo), and runtime errors (missing Electron IPC handlers,  path). Recent efforts have concentrated on refining Gemini Flash OCR (addressing UNKNOWN results by correcting MIME types, enforcing JSON-only responses, and better parsing) and implementing cost tracking per scan, reflecting a transition from foundational build stability to feature refinement and usability.
</analysis>

<product_requirements>
The application is a desktop OCR scanner for Vietnamese land-related documents, designed for accurate classification and renaming. Key features include single/batch scanning, history, PDF export, fuzzy matching, keyword-based classification, and automatic title assignment for sequential documents. It supports multiple OCR engines (Tesseract, VietOCR, EasyOCR) and Bring Your Own Key (BYOK) for Google Cloud Vision, Azure Computer Vision, and Gemini Flash, with GPT-4 Vision as a high-accuracy fallback (Cloud Boost). Recent enhancements focused on improving classification for specific Vietnamese document types and utilizing Position-Aware and Standalone Text rules. The user explicitly requested an all-in-one NSIS (.exe) installer for Windows (x64), using system Python (3.10-3.12) with dynamic PYTHONPATH, enabling Gemini Flash AI, with , , and . The user also required displaying estimated costs per scan and total for batch scans using AI Studio Gemini API, and fixing UNKNOWN classification results.
</product_requirements>

<key_technical_concepts>
- **Electron**: Desktop application framework.
- **React**: Frontend UI.
- **Python**: Backend for OCR and AI (Gemini Flash).
- **Electron-builder**: Packaging/building tool for Electron, including NSIS.
- **NSIS**: Scriptable Windows installer system.
- **Python Environment Management**: , , .
- **Gemini Flash API**: AI for OCR and document classification, token-based pricing.
- **IPC (Inter-Process Communication)**: Electron's mechanism for main/renderer process communication.
</key_technical_concepts>

<code_architecture>
The application is structured into , , and  directories.



-   ****:
    -   **Summary**: Central configuration for Electron-builder, scripts, dependencies.
    -   **Changes**:  field added. ,  configured.  array updated to include .  set to  with  architecture, ,  ().  points to .  now includes the  directory and potentially .  set to .  script added.
-   ****:
    -   **Summary**: Electron's main process, manages window lifecycle, IPC, and Python script execution.
    -   **Changes**: Python script path resolution now uses  for production. Dynamic  is set by detecting system Python (3.12->3.11->3.10) via  and fetching  at runtime. Added IPC handlers for , , ,  to manage Cloud OCR API keys with . Updated  icon logic to use  from  in production. Proposed changes for robust cache pathing and single-instance lock.
-   ****:
    -   **Summary**: Compiled version of .
    -   **Changes**: Synchronized with  modifications.
-   ****:
    -   **Summary**: Python script for Gemini Flash AI OCR.
    -   **Changes**: Modified to retrieve  (promptTokenCount, candidatesTokenCount) from Gemini API response. Forced image format to PNG and  to prevent MIME mismatches.  now includes  and  to enforce JSON-only output. Logic for parsing Gemini response updated to iterate through all  in  to find JSON. Prompt content refined to strictly demand JSON.
-   ****:
    -   **Summary**: Orchestrates document processing and OCR engine calls.
    -   **Changes**: Calculates  for Gemini Flash based on , , and rates from environment variables (, ). The estimated cost is returned in the JSON result.
-   ****:
    -   **Summary**: Main React component, handles routing and layout.
    -   **Changes**: Updated the app logo display in the header to use  for correct path resolution in Electron builds. Requires  to be in .
-   ****:
    -   **Summary**: Handles document scanning and displays results.
    -   **Changes**: Modified to display  and token counts (input, output) for individual scanned files when using Gemini Flash.
-   ** (New File)**:
    -   **Summary**: NSIS script for pre-installation Python checks.
    -   **Changes**: Contains logic to check for Python 3.10-3.12 using  or Python 3.11.14 and shows a dialog if not found.
-   ** (New File)**:
    -   **Summary**: PowerShell script to clean up accidentally bundled Python package folders from .
    -   **Changes**: Deletes directories like , , , , etc.
-   ** (New/Modified File)**:
    -   **Summary**: Build instructions for the NSIS installer on Windows.
    -   **Changes**: Provides detailed steps for building, cleaning Python packages, and testing with logs.
</code_architecture>

<pending_tasks>
- Implement full logic for the all-in-one installer using . (Partially done, pre-check implemented, full custom installer logic in progress).
- Fine-tune remaining document types in .
- Monitor OpenAI quota/plan for Emergent LLM Key (if Cloud Boost is used).
- Migrate or pin React/Webpack versions.
- Test the backend with 5-10 real images to validate Hybrid OCR.
- Update icon for macOS (.icns).
- Implement license/activation key feature.
- Implement Parallel Local Processing for batch scanning.
- Handle deep path length issues in the application.
- Implement Batch Scan from List feature.
- Address the slow startup of the app.
- Implement total cost for batch in UI (pending user confirmation from the last message).
- Add configurable single price rates (INPUT_RATE_PER_M, OUTPUT_RATE_PER_M) in Cloud Settings.
- Implement a code patch for robust cache pathing and single-instance lock in .
</pending_tasks>

<current_work>
Immediately before this summary, the AI engineer was focused on addressing persistent UNKNOWN classification results when using Gemini Flash OCR. The diagnosis pointed to issues in  related to:
1.  **MIME type mismatch**: Images were being saved in one format (e.g., JPEG) but declared as another (PNG) to the API.
2.  **Non-JSON-only prompt response**: Gemini model was not strictly returning JSON, causing parsing failures.
3.  **Incomplete response parsing**: Only  was being checked, potentially missing JSON in other parts of the response.

To resolve this, the  file was modified to:
-   **Enforce PNG format**: All images are now explicitly converted to PNG before base64 encoding, and  is correctly set to image/png.
-   **Refine prompt and generation config**: The prompt was updated to strictly demand a single line of JSON, and  was set to  and  to encourage stable, JSON-only output.
-   **Iterate through response parts**: The logic to extract text for JSON parsing now loops through all  to ensure the JSON content is found.

Additionally, the AI engineer previously implemented the display of  and token counts (input/output) per scanned file in the  component, responding to the user's request for Gemini API cost visibility. The last user interaction was asking about current naming rules and document types, to which a detailed explanation was provided.
</current_work>

<optional_next_step>
The next step is to get user confirmation for implementing the total cost for batch in the UI, as proposed in Chat Message 153.
</optional_next_step>
