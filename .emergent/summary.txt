<analysis>
The AI engineer has been meticulously developing and debugging a document scanning application. Initially, it built out core functionalities like OCR, automatic renaming, PDF export, batch processing, and a rules management UI. Significant effort was then directed towards performance, ZIP archive processing with folder structure preservation, and real-time progressive downloads. A crucial phase involved implementing a robust JWT authentication system with user registration, admin approval, and an admin panel.

The latest interactions primarily focused on resolving critical deployment-related issues and refining core logic. This included fixing persistent 520 errors on the deployed application, which required deep troubleshooting to identify scope issues in nested functions ( not accessible),  vs. UUID mismatches, and ensuring authentication headers were correctly applied across all frontend API calls. The AI engineer also addressed user feedback on history grouping, a scan more button, and refined the CONTINUATION document naming rule to be stricter, requiring exact matches for new document types.

The current challenge revolves around migrating the application to a production-grade environment, specifically Railway. The AI engineer has been providing multiple, increasingly updated guides for Railway deployment, continuously adapting to user feedback and Railway's evolving interface, while troubleshooting persistent build errors like pip: command not found.
</analysis>

<product_requirements>
The application's core purpose is to scan land-related document images, use OpenAI GPT-4 Vision for content recognition (especially Vietnamese text), and automatically rename them with predefined Vietnamese short codes (e.g., Giấy chứng nhận to GCN) before exporting as PDFs.

Key features implemented include:
1.  **Image Scanning & OCR**: OpenAI GPT-4 Vision for accurate recognition with Emergent LLM Key.
2.  **Automatic Naming**: Rule-based renaming using short codes.
3.  **PDF Export**: Single, merged, and smart merging of multi-page documents with dynamic paper size/orientation.
4.  **Batch Processing**: Simultaneous upload and scanning.
5.  **Scan History**: Maintained history with filename editing.
6.  **Performance Optimization**: Image resizing, dynamic cropping, client-side compression, backend concurrency.
7.  **Progress Tracking & Error Handling**: Real-time display of progress and errors.
8.  **Rules Management UI**: Frontend for managing recognition rules.

Recent additions/refinements:
1.  **Large-Scale Folder Scanning**: ZIP uploads, maintaining folder structure, individual PDF generation per file.
2.  **Folder-Based Processing**: Sequential scanning by sub-folders, real-time progressive downloads.
3.  **Authentication & Authorization**: User registration, mandatory JWT login, admin account (), admin panel for user management, history grouped by session.
4.  **Performance & UX Fixes**: Addressed slow upload/download, page scrolling, lazy-loading history.
5.  **Stricter Naming Rules**: AI should only change document type on 100% exact title match; otherwise, continue with the previous document type, not UNKNOWN.
6.  **Cross-Batch Grouping**: Maintain naming context across multiple uploaded batches.
7.  **Deployment to Railway**: User wants to move the application to Railway for better scalability and concurrent user support (up to 30 users).
</product_requirements>

<key_technical_concepts>
-   **Full-stack Development**: React (frontend), FastAPI (backend), MongoDB (database).
-   **AI/OCR**: OpenAI GPT-4 Vision, Emergent LLM Key for content recognition.
-   **Image Processing**: Pillow, .
-   **PDF Manipulation**: .
-   **Asynchronous Programming**: , .
-   **Authentication**: JWT (JSON Web Tokens), , Pydantic models.
-   **Routing**:  v7.
-   **Deployment**: Kubernetes (Emergent platform), Railway, Render.com, Docker/Nixpacks (for build configurations).
</key_technical_concepts>

<code_architecture>
The application follows a standard full-stack architecture with a FastAPI backend and a React frontend.



-   ****:
    -   **Importance**: Core backend logic. Handles API, LLM, DB, PDF. Now includes ZIP processing, folder-based scanning, and authentication routes.
    -   **Changes Made**:
        -   Changed  from POST to GET, then modified to delete existing admin users before creating a new one.
        -   Removed temporary  endpoint and related  import.
        -   Modified prompt for GPT-4 Vision to enforce 100% exact match for document titles and remove CONTINUATION short code.
        -   Updated  logic to handle stricter naming rules, propagating  more robustly and ensuring trang 1 is added for new documents.
        -   Introduced  into  model and  endpoint to group scans.
        -   Fixed  values and added  and  to .
        -   Addressed scope issues in nested  and  functions by passing  explicitly.
        -   Modified  to accept  to maintain grouping context across multiple batches.
-   ****:
    -   **Importance**: Main React Router component.
    -   **Changes Made**: Added a route for the new  page.
-   ****:
    -   **Importance**: Main document scanner UI and logic.
    -   **Changes Made**: Added  helper function and applied authentication headers to all API calls (batch scan, folder scan, delete, update filename, export, clear history). Fixed a syntax error (extra ). Added a Quét thêm (Scan more) button. Updated  to send .
-   ****:
    -   **Importance**: Authentication utilities (hashing, JWT).
    -   **Changes Made**: Increased JWT  from 30 minutes to 24 hours.
-   ****:
    -   **Importance**: FastAPI dependencies for authentication.
    -   **Changes Made**: Modified  to handle  as a string (UUID) instead of converting to , preventing crashes.
-   ****: **New file created**. Provides UI and logic for setting up the admin user, including messages for success/failure and warnings about existing admin accounts.
-   ****:
    -   **Importance**: Component for managing document rules.
    -   **Changes Made**: Integrated  hook and added authentication headers to , , , and  API calls.
-   ****: **New file created**. Excludes  and  to prevent large files from being included in Docker builds.
-   **, **: **New files created**. Configuration files for Railway deployment (though their usage/efficacy is still being determined by recent Railway changes).
-   **, **: **New files created**. Nixpacks configuration files (also part of the evolving Railway deployment strategy).
-   **, **: **New files created**. Procfile for process commands on platforms like Railway.
-   ****:
    -   **Importance**: Node.js dependencies and scripts.
    -   **Changes Made**: Added  package for static file serving.
</code_architecture>

<pending_tasks>
-   Resolve the  error during Railway deployment, which indicates an issue with Python environment setup or  configuration.
-   Successfully deploy the application to Railway, following the latest instructions for their updated interface.
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was attempting to guide the user through deploying the application to Railway. The user reported a recurring build error on Railway: RUN pip install -r requirements.txt /bin/bash: line 1: pip: command not found Error: Docker build failed (Chat Message 600). This indicates that the 
Usage:   
  pip <command> [options]

Commands:
  install                     Install packages.
  lock                        Generate a lock file.
  download                    Download packages.
  uninstall                   Uninstall packages.
  freeze                      Output installed packages in requirements format.
  inspect                     Inspect the python environment.
  list                        List installed packages.
  show                        Show information about installed packages.
  check                       Verify installed packages have compatible dependencies.
  config                      Manage local and global configuration.
  search                      Search PyPI for packages.
  cache                       Inspect and manage pip's wheel cache.
  index                       Inspect information available from package indexes.
  wheel                       Build wheels from your requirements.
  hash                        Compute hashes of package archives.
  completion                  A helper command used for command completion.
  debug                       Show information useful for debugging.
  help                        Show help for commands.

General Options:
  -h, --help                  Show help.
  --debug                     Let unhandled exceptions propagate outside the
                              main subroutine, instead of logging them to
                              stderr.
  --isolated                  Run pip in an isolated mode, ignoring
                              environment variables and user configuration.
  --require-virtualenv        Allow pip to only run in a virtual environment;
                              exit with an error otherwise.
  --python <python>           Run pip with the specified Python interpreter.
  -v, --verbose               Give more output. Option is additive, and can be
                              used up to 3 times.
  -V, --version               Show version and exit.
  -q, --quiet                 Give less output. Option is additive, and can be
                              used up to 3 times (corresponding to WARNING,
                              ERROR, and CRITICAL logging levels).
  --log <path>                Path to a verbose appending log.
  --no-input                  Disable prompting for input.
  --keyring-provider <keyring_provider>
                              Enable the credential lookup via the keyring
                              library if user input is allowed. Specify which
                              mechanism to use [auto, disabled, import,
                              subprocess]. (default: auto)
  --proxy <proxy>             Specify a proxy in the form
                              scheme://[user:passwd@]proxy.server:port.
  --retries <retries>         Maximum attempts to establish a new HTTP
                              connection. (default: 5)
  --timeout <sec>             Set the socket timeout (default 15 seconds).
  --exists-action <action>    Default action when a path already exists:
                              (s)witch, (i)gnore, (w)ipe, (b)ackup, (a)bort.
  --trusted-host <hostname>   Mark this host or host:port pair as trusted,
                              even though it does not have valid or any HTTPS.
  --cert <path>               Path to PEM-encoded CA certificate bundle. If
                              provided, overrides the default. See 'SSL
                              Certificate Verification' in pip documentation
                              for more information.
  --client-cert <path>        Path to SSL client certificate, a single file
                              containing the private key and the certificate
                              in PEM format.
  --cache-dir <dir>           Store the cache data in <dir>.
  --no-cache-dir              Disable the cache.
  --disable-pip-version-check
                              Don't periodically check PyPI to determine
                              whether a new version of pip is available for
                              download. Implied with --no-index.
  --no-color                  Suppress colored output.
  --use-feature <feature>     Enable new functionality, that may be backward
                              incompatible.
  --use-deprecated <feature>  Enable deprecated functionality, that will be
                              removed in the future.
  --resume-retries <resume_retries>
                              Maximum attempts to resume or restart an
                              incomplete download. (default: 5) command is not available in the build environment when Railway attempts to install Python dependencies. The user also noted that the Railway deployment process seemed to have changed significantly from previous instructions (Chat Message 596, 598).

The AI engineer had created several configuration files (, ,  for both backend and frontend) and modified  to include a  script, attempting to address Railway's monorepo and build process. However, the  error suggests a more fundamental issue with how Railway's build system (likely Nixpacks) is setting up the Python environment, or how the  or explicit build commands are configured. The AI engineer acknowledges this as a  config issue and is preparing to address it.
</current_work>

<optional_next_step>
Provide the corrected Nixpacks configuration or Railway build commands to resolve the  error for the backend service.
</optional_next_step>
