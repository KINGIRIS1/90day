<analysis>**original_problem_statement:**
Ban đầu, người dùng yêu cầu sửa lỗi phân loại tài liệu của engine OCR, tối ưu hóa giao diện người dùng và cải thiện hiệu suất.

Các yêu cầu chính trong phiên làm việc này bao gồm:
1.  **Sửa lỗi nghiêm trọng**: Khắc phục lỗi logic khiến tất cả tài liệu GCN bị đổi tên thành .
2.  **Cải thiện độ chính xác AI**: Cập nhật AI prompt để phân biệt chính xác giữa GCN trang 1 và HSKT.
3.  **Đồng bộ cài đặt**: Đảm bảo tab Only GCN sử dụng chế độ OCR (batch/sequential) từ trang Cài đặt chung, thay vì hardcode.
4.  **Thêm tính năng quét PDF**: Triển khai khả năng quét file PDF trên toàn bộ ứng dụng.
5.  **Tối ưu quét PDF**: Tách các file PDF nhiều trang thành các ảnh riêng lẻ và xử lý chúng ở chế độ hàng loạt (batch mode) để tăng tốc độ.
6.  **Sửa lỗi quét PDF**: Khắc phục sự cố quá trình quét PDF bị dừng giữa chừng và trả về kết quả không đầy đủ.
7.  **Tiện ích**: Tạo các file  để khởi động ứng dụng dễ dàng hơn trên Windows.

**User's preferred language**: Vietnamese

**what currently exists?**
- Lỗi nghiêm trọng GTLQ đã được khắc phục bằng cách loại bỏ hoàn toàn logic chuyển đổi sai trong .
- AI prompt () đã được cải thiện để phân biệt rõ hơn giữa GCN và HSKT.
- Tab Only GCN hiện đã đồng bộ với cài đặt OCR toàn cục.
- Tính năng quét PDF đã được triển khai trên toàn bộ ứng dụng. Logic này bao gồm việc chuyển đổi các trang PDF thành ảnh bằng thư viện  và .
- Logic đã được thêm vào  và  để tự động phát hiện file PDF, tách trang thành ảnh, và đưa các ảnh này vào quy trình xử lý hàng loạt (batch mode) theo cài đặt của người dùng.
- Một số lỗi phát sinh trong quá trình triển khai (lỗi , , và hardcode chế độ batch) đã được sửa.

**Last working item**:
- **Last item agent was working**: Người dùng báo cáo rằng khi quét một file PDF có nhiều trang (ví dụ: 34 trang), quá trình quét dừng lại sớm (ví dụ: sau khi xử lý 1-2 batch) và giao diện người dùng (UI) hiển thị kết quả không đầy đủ, mặc dù log backend cho thấy nó đang bắt đầu xử lý batch tiếp theo. Agent đã xác định rằng tiến trình Python () đang kết thúc trước khi tất cả các batch được xử lý xong, gây ra việc UI nhận tín hiệu hoàn thành một cách sai lầm.
- **Status**: IN PROGRESS
- **Agent Testing Done**: N
- **Which testing method agent to use?**: backend testing agent. Tác nhân cần phân tích luồng tương tác giữa Electron và tiến trình con Python. Cụ thể là kiểm tra các file  (handler ) và  để tìm ra tại sao tiến trình con lại kết thúc sớm khi xử lý nhiều batch.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1 (P0)**: Quá trình quét PDF theo batch kết thúc sớm, trả về kết quả không đầy đủ.
- **Issue 2 (P1)**: Độ chính xác của AI vẫn chưa nhất quán.
- **Issue 3 (P2)**: Logic ghép cặp GCN trang 1 và trang 2 để đồng bộ ngày cấp chưa hoàn thiện.
- **Issue 4 (P3)**: Chức năng sửa kết quả trong khi quét chưa được triển khai.

**Issues Detail:**
- **Issue 1: Quá trình quét PDF theo batch kết thúc sớm, trả về kết quả không đầy đủ**
  - **Attempted fixes**: Agent đã triển khai logic tách PDF thành ảnh và xử lý theo batch. Tuy nhiên, kiến trúc hiện tại nơi Electron chờ tiến trình Python kết thúc ( event) không hoạt động đúng với các tác vụ dài hơi có nhiều batch. Tiến trình Python () dường như trả về quyền điều khiển và thoát sau khi khởi chạy batch đầu tiên, thay vì chờ tất cả các batch hoàn thành.
  - **Next debug checklist**:
    1.  Kiểm tra file : Đảm bảo rằng hàm  phải  hoặc chờ cho đến khi hàm xử lý batch (ví dụ ) thực sự hoàn thành tất cả các batch trước khi script in ra JSON cuối cùng và thoát.
    2.  Kiểm tra file : Xem xét lại cách nó quản lý tiến trình con. Liệu có cách nào để nhận các kết quả trung gian (streaming) thay vì chỉ chờ tiến trình kết thúc không? Tuy nhiên, giải pháp khả thi hơn là sửa logic ở backend.
    3.  **Giả thuyết**: Hàm gọi xử lý batch trong  đang không blocking (non-blocking), khiến cho phần còn lại của script thực thi và thoát ngay lập tức.
  - **Why fix this issue and what will be achieved with the fix?**: Đây là lỗi chặn (blocker) đối với tính năng quét PDF. Sửa lỗi này sẽ giúp người dùng có thể quét các file PDF lớn một cách đáng tin cậy.
  - **Status**: IN PROGRESS
  - **Is recurring issue?**: N
  - **Should Test frontend/backend/both after fix?**: Backend.
  - **Blocked on other issue**: None.

- **Issue 2: Độ chính xác của AI vẫn chưa nhất quán**
  - **Attempted fixes**: Cập nhật prompt trong  với các quy tắc rõ ràng hơn để phân biệt GCN và HSKT.
  - **Why fix this issue and what will be achieved with the fix?**: Cải thiện độ tin cậy và chính xác của chức năng cốt lõi.
  - **Status**: USER VERIFICATION PENDING
  - **Is recurring issue?**: Y
  - **Should Test frontend/backend/both after fix?**: Backend (AI prompt).
  - **Blocked on other issue**: None.

- **Issue 3: Logic ghép cặp GCN trang 1 và trang 2 chưa hoàn thiện**
  - **Attempted fixes**: Chưa có. Yêu cầu này đã có từ các phiên trước.
  - **Why fix this issue and what will be achieved with the fix?**: Tăng độ chính xác của việc phân loại GCNC/GCNM.
  - **Status**: NOT STARTED
  - **Is recurring issue?**: N
  - **Should Test frontend/backend/both after fix?**: Frontend.
  - **Blocked on other issue**: Issue 1, Issue 2.

- **Issue 4: Chức năng sửa kết quả trong khi quét chưa được triển khai**
  - **Attempted fixes**: Chưa có.
  - **Why fix this issue and what will be achieved with the fix?**: Cải thiện trải nghiệm người dùng, cho phép họ làm việc song song mà không phải chờ quét xong.
  - **Status**: NOT STARTED
  - **Is recurring issue?**: N
  - **Should Test frontend/backend/both after fix?**: Frontend.
  - **Blocked on other issue**: None.

**In progress Task List**:
- **Task 1: Hoàn thiện tính năng quét PDF (P0)**
  - **Where to resume**: Debug và sửa lỗi tiến trình Python () kết thúc sớm khi xử lý PDF nhiều trang ở chế độ batch.
  - **What will be achieved with this?**: Một tính năng quét PDF hoạt động ổn định và hiệu quả trên toàn bộ ứng dụng.
  - **Status**: IN PROGRESS
  - **Should Test frontend/backend/both after fix?**: Backend.
  - **Blocked on something**: Issue 1.

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
    - **(P1)** Triển khai logic ghép cặp GCN trang 1 và 2 để đồng bộ ngày cấp (Issue 3).
    - **(P2)** Triển khai chế độ OCR Hybrid.
- **Future Tasks**:
    - Thêm icon cho ứng dụng trên macOS.
    - Triển khai hệ thống license key.
    - Thêm cấu hình giá trong phần Cài đặt.

**Completed work in this session**
- **Sửa lỗi nghiêm trọng**:
  - Đã loại bỏ hoàn toàn logic convert to GTLQ sai lầm trong .
  - Đã sửa lỗi  của Gemini API bằng cách tăng .
  - Đã sửa lỗi  và  trong các script Python.
- **Cải tiến & Đồng bộ**:
  - Cải thiện AI prompt để phân biệt GCN và HSKT tốt hơn.
  - Đồng bộ hóa tab Only GCN để tuân theo cài đặt OCR toàn cục.
- **Tính năng mới: Quét PDF**:
  - Thêm khả năng quét file PDF vào tất cả các chế độ quét (Single file, Batch, OnlyGCN).
  - Triển khai logic tách các trang của file PDF thành các file ảnh riêng lẻ bằng  và .
  - Tối ưu hóa quá trình xử lý các trang PDF đã tách bằng cách đưa chúng vào chế độ xử lý hàng loạt (batch).
- **Tiện ích**: Tạo các file  để giúp người dùng chạy ứng dụng dễ dàng hơn.

**Known issue recurrence from previous fork**
- **Issue recurrence**: Lỗi phân loại tài liệu không nhất quán của AI.
- **Recurrence count**: Cao.
- **Status**: IN PROGRESS (Các bản sửa lỗi prompt đã được áp dụng, cần theo dõi thêm).

**Code Architecture**
- **Frontend**: React
- **Backend**: Python
- **Main Process**: Electron
- **Tương tác chính gây lỗi**:  ->  -> . Luồng điều khiển và chờ kết quả đang bị lỗi đối với các tác vụ dài hơi.

**Key Technical Concepts**
- **Quản lý tiến trình con (Child Process Management)**: Electron sử dụng  để chạy các script Python và chờ sự kiện  để lấy kết quả. Kiến trúc này đang gặp vấn đề với các tác vụ xử lý hàng loạt kéo dài.
- **Quy trình xử lý PDF**: Một quy trình mới đã được thiết lập: Nhận diện PDF -> Tách PDF thành ảnh () -> Đưa ảnh vào quy trình xử lý hàng loạt () -> Xóa file ảnh tạm.

**changes in tech stack**
- Thêm  vào . Điều này yêu cầu người dùng phải cài đặt  trên hệ thống của họ.

**All files**
- **Tạo mới**:
  - : Module để chuyển đổi các trang PDF thành ảnh.
  -  (và các file .bat khác): Scripts để chạy ứng dụng.
  - Nhiều file tài liệu .
- **Cập nhật nhiều**:
  - : **File quan trọng cho lỗi hiện tại**. Đã thêm logic xử lý PDF và gọi các chế độ batch.
  - : Cập nhật để xử lý các luồng ảnh từ PDF.
  - : **File quan trọng cho lỗi hiện tại**. Cập nhật để truyền cài đặt batch mode.
  - , : Cập nhật để hỗ trợ PDF.
  - , , .

**Critical Info for New Agent**
- **BLOCKER HIỆN TẠI**: Vấn đề cốt lõi là  kết thúc và trả về cho Electron quá sớm khi xử lý một file PDF lớn có nhiều batch. Hãy tập trung vào việc đảm bảo script Python chỉ thoát sau khi *tất cả* các batch đã được xử lý xong.
- **PHỤ THUỘC MÔI TRƯỜNG**: Tính năng quét PDF yêu cầu người dùng phải cài đặt . Hãy ghi nhớ điều này nếu có vấn đề liên quan đến việc convert PDF.
- **LUỒNG LOGIC**: Luồng xử lý PDF phức tạp và đi qua nhiều file:  ->  ->  -> . Khi debug, cần theo dõi log trên tất cả các file này.

**Last 5 User Messages and any pending user messages**
1.  **User**: Kết quả trả về sớm khi chưa quét hết các file và chỉ có 1 trang. (PENDING - Đây là lỗi P0 hiện tại).
2.  **User**: Đến batch 2 thì dừng và trả kết quả luôn. (PENDING - Chi tiết thêm của lỗi P0).
3.  **User**: Vẫn chưa sử dụng cài đặt, đang chạy batch theo hardcode. (COMPLETED - Agent đã sửa).
4.  **User**: Batch 5 và smart phải sử dụng *sau khi* chia file pdf. (COMPLETED - Agent đã sửa).
5.  **User**: Lỗi  và batch mode phải theo cài đặt. (COMPLETED - Agent đã sửa).

**Project Health Check:**
- **Broken**: Tính năng quét PDF cho các file nhiều trang ở chế độ batch đang bị hỏng nặng. Nó không thể hoàn thành và trả về kết quả sai, làm cho tính năng này không thể sử dụng được.

**Testing status**
- Testing agent used after significant changes: NO
- Troubleshoot agent used after agent stuck in loop: NO
- Test files created: None
- Known regressions: Tính năng quét PDF mới được thêm vào không hoạt động như mong đợi.</analysis>
