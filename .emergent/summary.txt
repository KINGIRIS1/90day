<analysis>
The previous AI engineer successfully transformed a desktop OCR application for Vietnamese land documents. Initial efforts stabilized the Windows Electron build and integrated Gemini Flash AI, including cost tracking and resolving UNKNOWN classifications through detailed prompt engineering. Significant work was dedicated to cost optimization via prompt deduplication (42.1% token reduction) and implementing smart image resizing with user-configurable settings.

Key challenges involved fine-tuning classification for numerous Vietnamese document types, leading to iterative prompt refinements for Flash Lite, and robustly addressing API rate limits by adding a user-adjustable delay for sequential file processing. The engineer also provided comprehensive user education on Gemini API billing tiers and troubleshooting quota issues. The work culminated in fixing specific classification errors in Flash Lite, including adding visual recognition cues. The immediate next task, where the trajectory ended, is to resolve a case-sensitivity issue in document code validation for the TTr code.
</analysis>

<product_requirements>
The application is a desktop OCR scanner for Vietnamese land documents, designed to accurately classify and rename documents. It supports single and batch scanning, history management, PDF export, fuzzy matching, keyword classification, and automatic title assignment. It integrates multiple OCR engines including Tesseract, VietOCR, EasyOCR, and cloud-based solutions like Google Cloud Vision, Azure Computer Vision, and Gemini Flash (with GPT-4 Vision for Cloud Boost). Recent focus has been on improving classification for specific Vietnamese document types using Position-Aware and Standalone Text rules. Key user requests included an all-in-one NSIS Windows x64 installer using system Python (3.10-3.12), enabling Gemini Flash AI (AppName: 90dayChonThanh, Company: Nguyen Thin Trung, Version: 1.1.0), displaying estimated costs per scan/batch, fixing UNKNOWN classifications (especially for GTLQ and specific text patterns), providing a UI option to switch between Gemini Flash and Flash Lite, and optimizing prompt tokens and image size to reduce API costs while maintaining accuracy.
</product_requirements>

<key_technical_concepts>
-   **Electron**: Desktop app framework.
-   **React**: Frontend UI.
-   **Python**: Backend for OCR and AI.
-   **Electron-builder/NSIS**: Packaging Windows installers.
-   **Python Environment Management**: Dynamic  detection.
-   **Gemini Flash API**: Google's multimodal AI for OCR and classification, token-based pricing.
-   **IPC**: Electron's inter-process communication.
-   **Prompt Engineering**: Optimizing LLM inputs for specific tasks.
-   **Image Processing**: Using PIL for resizing.
</key_technical_concepts>

<code_architecture>
The application is structured into , , and  directories.



-   ****:
    -   **Summary**: Configuration for Electron-builder, scripts.
    -   **Changes**:  script added for Windows compatibility (yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.).
-   ****:
    -   **Summary**: Electron's main process, window management, IPC, Python execution.
    -   **Changes**: Added IPC handlers for  and  to manage general settings, including image resizing and request delay. Updated  to pass , , , and  as environment variables to the Python script.
-   ****:
    -   **Summary**: Compiled version of .
    -   **Changes**: Synchronized with  modifications.
-   ****:
    -   **Summary**: Python script for Gemini Flash AI OCR and classification.
    -   **Changes**:
        -   Added image resizing logic (using PIL) before sending to Gemini API, based on , ,  settings, returning .
        -   Implemented two distinct prompt functions:  for Flash (full, detailed) and  for Flash Lite (optimized, concise).
        -   Logic to dynamically select between these prompts based on .
        -    was iteratively refined to include specific rule examples (e.g., DDKBD, GTLQ, PKTHS, PCT, GNT, TBT) and visual recognition hints (e.g., quốc huy) while avoiding new code creation, reverting .
        -   Added error handling for API errors (rate limits, quota exhaustion).
        -   **Current Issue**:  at line 1359 is forcing all codes to uppercase, causing a validation failure for codes like 'TTr' which are case-sensitive in the valid codes list.
-   ****:
    -   **Summary**: Orchestrates document processing and OCR engine calls.
    -   **Changes**: Modified  to accept and pass , , , and  to the OCR engine.
-   ** (NEW)**:
    -   **Summary**: New script to calculate and display estimated costs for different Gemini models (Flash, Flash Lite) with and without image resizing.
    -   **Changes**: Created to provide a clear breakdown of pricing.
-   ****:
    -   **Summary**: Main React component.
    -   **Changes**: App logo path updated to use .
-   ****:
    -   **Summary**: Handles document scanning and displays results.
    -   **Changes**:
        -   Now displays , token counts, and  for scanned files.
        -   **Added  state and a UI slider** for users to configure delay between sequential scans.
        -   Implemented a  function within the scan loop () to prevent rate limit issues, this was added to the existing sequential processing.
        -   Integrated the new  component and updated error handling to show quota warnings.
-   ****:
    -   **Summary**: Manages cloud OCR engine settings, API key, and model selection.
    -   **Changes**:
        -   Implemented UI radio buttons for Gemini Flash/Flash Lite selection, storing selected model with API key.
        -   **Added UI section for image resize settings**: enable/disable toggle, max width/height inputs.
        -   Added UI for displaying the cost estimation table from .
        -   Includes guidance on Gemini API quota management.
-   ** (NEW)**:
    -   **Summary**: New React component to display warnings about Gemini API rate limits or quota exhaustion.
    -   **Changes**: Created to inform users about API limits and guide them on resolution.
-   **New Markdown Files**: , , , , , ,  were created to document features and troubleshooting steps.
</code_architecture>

<pending_tasks>
- Implement full logic for the all-in-one installer using .
- Fine-tune remaining document types in  and .
- Monitor OpenAI quota/plan for Emergent LLM Key (if Cloud Boost is used).
- Migrate or pin React/Webpack versions.
- Test the backend with 5-10 real images to validate Hybrid OCR.
- Update icon for macOS (.icns).
- Implement license/activation key feature.
- Implement Parallel Local Processing for batch scanning.
- Handle deep path length issues in the application.
- Implement Batch Scan from List feature.
- Address the slow startup of the app.
- Add configurable single price rates (INPUT_RATE_PER_M, OUTPUT_RATE_PER_M) in Cloud Settings.
- Implement a code patch for robust cache pathing and single-instance lock in .
</pending_tasks>

<current_work>
Immediately before this summary request, the AI engineer was diagnosing a classification error for the document code TTr (Tờ trình) when using Gemini Flash Lite. The user provided console logs indicating that Gemini returned TTr correctly, but the application's internal validation system was flagging it as an INVALID code TTR after sanitization.

The AI engineer successfully identified the root cause: a line in  (specifically, ) was forcing all returned document codes to uppercase before validation. This caused a mismatch with the stored list of valid codes, which includes TTr with a lowercase 'r'. The problem is a case-sensitivity issue introduced by an aggressive sanitization step in the Python OCR engine. The fix needs to ensure that the sanitization process respects the expected casing for document codes or that the validation is case-insensitive.
</current_work>

<optional_next_step>
Adjust the  sanitization logic in  to correctly handle case-sensitive document codes like TTr.
</optional_next_step>
