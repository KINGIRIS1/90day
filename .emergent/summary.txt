<analysis>Tuyệt vời, đây là bản tóm tắt bàn giao chi tiết để kỹ sư AI tiếp theo có thể tiếp tục công việc một cách liền mạch.

**original_problem_statement:**
Người dùng yêu cầu một loạt các cải tiến và sửa lỗi cho ứng dụng OCR trên máy tính để bàn (desktop). Các yêu cầu chính bao gồm:
1.  **Sửa lỗi Resume:** App không tự động tiếp tục quét và không tự động chuyển đến tab đang làm việc dở dang.
2.  **Cải thiện UI:** Giao diện Quét theo danh sách (Batch Scanner) phức tạp, cần thiết kế lại cho gọn gàng, chuyên nghiệp và có nhiều không gian làm việc hơn.
3.  **Sắp xếp GCN:** Đảm bảo tính năng sắp xếp tài liệu GCN (Giấy chứng nhận) lên đầu danh sách kết quả được áp dụng cho tất cả các chế độ quét.
4.  **Sửa lỗi Gộp PDF:** Logic gộp file PDF ở Quét file và Quét thư mục không đúng quy tắc và không nhất quán với Quét danh sách.
5.  **Sửa lỗi Phân loại GCN:** Một số tài liệu GCN không được phân loại thành GCN cũ (GCNC) hoặc GCN mới (GCNM) mà vẫn giữ nguyên là GCN.
6.  **Tối ưu UX:** Di chuyển nút Gộp tab này lên vị trí dễ thấy hơn.
7.  **Lỗi Chế độ Smart Batch:** Chế độ Smart gửi quá nhiều file cùng lúc (15-20 file) gây ra lỗi fallback. Cần thêm tùy chọn để người dùng tự cấu hình số lượng file.
8.  **Lỗi Crash Liên tục:** Ứng dụng bị crash liên tục với lỗi , đặc biệt khi mở nhiều thư mục con (folder tabs).

**what currently exists?**
Ứng dụng là một công cụ OCR cho tài liệu đất đai của Việt Nam, được xây dựng bằng Electron, React và Python, sử dụng API Gemini Flash cho việc nhận dạng và phân loại. Các tính năng chính bao gồm quét file/thư mục đơn lẻ và quét hàng loạt theo danh sách. Phiên làm việc vừa qua đã tập trung vào việc sửa các lỗi nghiêm trọng, cải thiện giao diện người dùng và tối ưu hóa trải nghiệm người dùng, nhưng đang gặp phải một lỗi crash nghiêm trọng liên quan đến quản lý bộ nhớ.

**Last working item**:
    - Last item agent was working on: Giải quyết lỗi crash liên tục của renderer process (). Người dùng đã chỉ ra nguyên nhân cốt lõi: ứng dụng đang render **tất cả** các tab thư mục con cùng một lúc (ngay cả khi chúng bị ẩn), khiến bộ nhớ bị quá tải do phải tải quá nhiều ảnh base64. Kỹ sư AI đã xác định được đoạn code sai trong  (sử dụng  để render tất cả các tab) và đang chuẩn bị sửa lại để chỉ render tab đang được kích hoạt (lazy rendering).
    - Status: **IN PROGRESS**
    - Agent Testing Done: N
    - Which testing method agent to use? Frontend testing agent. Sau khi sửa lỗi, cần kiểm tra kỹ bằng cách tạo nhiều tab thư mục con để xác nhận ứng dụng không còn bị crash và hoạt động ổn định. Dùng screenshot tool để xác nhận UI không bị vỡ.
    - User Testing Done: N

**All Pending/In progress Issue list**:
  - **Issue 1 (P0): Renderer process crash (exitCode: -36861)**
     - Attempted fixes:
        - Phân trang kết quả (giảm từ 50 xuống 20, rồi 10 ảnh/trang).
        - Tự động tắt preview khi có quá nhiều file.
        - Mặc định tắt preview.
        - **Lý do thất bại:** Các cách trên chỉ là giải pháp tạm thời, không giải quyết được vấn đề gốc là tất cả các component của tab ẩn vẫn được render và giữ ảnh base64 trong bộ nhớ.
     - Next debug checklist:
        - Mở file .
        - Tìm đến đoạn code render các tab thư mục con (khoảng dòng 2475).
        - Thay đổi logic từ  (render tất cả) thành tìm tab đang active () và chỉ render component của tab đó.
     - Why fix this issue and what will be achieved with the fix? Đây là lỗi nghiêm trọng nhất làm ứng dụng không thể sử dụng được khi quét nhiều thư mục con. Sửa lỗi này sẽ giúp ứng dụng ổn định và chạy mượt mà.
     - Status: **IN PROGRESS**
     - Is recurring issue? Y
     - Should Test frontend/backend/both after fix? frontend
     - Blocked on other issue: No

  - **Issue 2 (P1): Tối ưu hóa prompt Gemini**
     - Attempted fixes: Kỹ sư đã phân tích prompt và tạo các file đề xuất chi tiết (, ).
     - Next debug checklist: Chờ người dùng xác nhận sẽ implement phương án tối ưu nào (A - Mạnh, B - Vừa phải, hay C - Nhẹ).
     - Why fix this issue and what will be achieved with the fix? Giảm chi phí token cho mỗi lần quét, giúp tiết kiệm chi phí API Gemini.
     - Status: **BLOCKED** (chờ quyết định của người dùng)
     - Is recurring issue? N
     - Should Test frontend/backend/both after fix? backend (kiểm tra độ chính xác sau khi thay đổi prompt)
     - Blocked on other issue: No

**In progress Task List**:
  - Không có.

**Upcoming and Future Tasks**
    - **Upcoming Tasks**:
        - (P1) Implement phương án tối ưu prompt đã được chọn (file ).
        - (P2) Giải quyết cảnh báo dung lượng disk đầy () xuất hiện liên tục trong log.
    - **Future Tasks**:
        - Tinh chỉnh các loại tài liệu còn lại trong .
        - Cập nhật icon cho macOS (.icns).
        - Implement tính năng license/activation key.
        - Thêm tùy chọn cấu hình giá cho mỗi lần quét trong Cloud Settings.

**Completed work in this session**
- **Sửa lỗi Auto-Resume:**
  - Sửa logic để tự động tiếp tục quét cho cả File Scan và Folder Scan trong .
  - Sửa lỗi tự động chuyển về đúng tab (Quét tài liệu hoặc Quét danh sách) khi resume trong .
  - Ngăn chặn hiển thị nhiều dialog Resume trùng lặp bằng cách giới hạn việc kiểm tra chỉ ở các component chính trong  và .
- **Cải thiện UI/UX:**
  - Thiết kế lại hoàn toàn giao diện Quét danh sách () theo mockup người dùng duyệt, giúp giao diện gọn gàng và chuyên nghiệp hơn.
  - Di chuyển nút Gộp tab này lên phần header của lưới kết quả trong cả  và .
- **Sửa lỗi Logic lõi:**
  - **Sắp xếp GCN:** Đảm bảo hàm  được gọi ở tất cả các chế độ quét trong .
  - **Gộp PDF:** Đồng bộ hóa hoàn toàn logic gộp PDF (bao gồm cả 3 tùy chọn lưu file) cho File Scan và Folder Scan () để giống với Batch Scan ().
  - **Phân loại GCN:** Sửa logic trong  () để đảm bảo không còn tài liệu nào bị giữ nguyên là GCN mà sẽ được phân loại thành GCNC hoặc GCNM.
- **Sửa lỗi Backend & Stability:**
  - **Chế độ Smart Batch:** Thêm tùy chọn Smart Batch Size trong  và truyền xuống  để người dùng tự cấu hình, tránh lỗi fallback do gửi quá nhiều file.
  - **Gemini API Error:** Thêm cơ chế retry cho lỗi  từ API Gemini trong .
  - **Lỗi Resume:** Thêm cơ chế  và xử lý lỗi mạnh mẽ hơn khi load state bị hỏng trong , tránh crash lặp lại.

**Earlier issues found/mentioned but not fixed**
   - **Issue 1: Disk Space Warning**
     - Debug checklist:
        - Kiểm tra xem các file build cũ, cache, hoặc log có đang chiếm dung lượng không.
        - Chạy lệnh 0	/app/0.6
0	/app/=
8.0K	/app/BATCH_UPLOAD_SOLUTION.md
8.0K	/app/CLOUD_BOOST_COMPLETE.md
16K	/app/COST_OPTIMIZATION_ALTERNATIVES.md
8.0K	/app/DEPLOYMENT_FIXES_APPLIED.md
20K	/app/DESKTOP_APP_ARCHITECTURE.md
8.0K	/app/DESKTOP_APP_IMPLEMENTATION.md
8.0K	/app/DESKTOP_APP_PHASE1_COMPLETE.md
12K	/app/DESKTOP_APP_TESTING_CHECKLIST.md
4.0K	/app/EMERGENT_LLM_KEY_GUIDE.md
4.0K	/app/FIX_PDF_IMAGE_ERROR.md
8.0K	/app/PERFORMANCE_ANALYSIS.md
8.0K	/app/PRICING_GUIDE.md
8.0K	/app/RAILWAY_DEBUG_FAILED_FETCH.md
8.0K	/app/RAILWAY_DEBUG_INTERNAL_ERROR.md
8.0K	/app/RAILWAY_DEPLOYMENT_CHECKLIST.md
12K	/app/RAILWAY_DEPLOYMENT_GUIDE.md
8.0K	/app/RAILWAY_FIX_INTERNAL_SERVER_ERROR.md
4.0K	/app/RAILWAY_FIX_PIP_ERROR.md
8.0K	/app/RAILWAY_FIX_SUMMARY.md
8.0K	/app/RAILWAY_FRONTEND_VS_BACKEND_URL.md
12K	/app/RAILWAY_HUONG_DAN_TIENG_VIET.md
8.0K	/app/RAILWAY_NEXT_STEPS.md
8.0K	/app/RAILWAY_QUICK_START.md
24K	/app/RAILWAY_SO_DO.md
8.0K	/app/RAILWAY_TOM_TAT.md
8.0K	/app/RAILWAY_WRONG_LOGS.md
4.0K	/app/README.md
12K	/app/SEQUENTIAL_NAMING_COMPLETE.md
12K	/app/additional_folder_tests.py
4.0K	/app/auth_test.py
2.6G	/app/backend
12K	/app/backend_test.py
16K	/app/comprehensive_rule_validation_results.json
20K	/app/comprehensive_rule_validation_test.py
1.6G	/app/desktop-app
218M	/app/desktop-app.zip
16K	/app/desktop_ocr_validation_test.py
20K	/app/direct_folder_test.py
12K	/app/easyocr_direct_test.py
16K	/app/focused_backend_test.py
4.0K	/app/focused_desktop_validation_results.json
16K	/app/focused_desktop_validation_test.py
20K	/app/focused_test_three_flows.py
20K	/app/folder_scan_test.py
704M	/app/frontend
4.0K	/app/llm_health_output.log
16K	/app/llm_health_test.py
16K	/app/llm_integration_test.py
12K	/app/node_modules
4.0K	/app/package-lock.json
12K	/app/review_test.py
4.0K	/app/simple_llm_health_test.py
4.0K	/app/test_deployed.sh
8.0K	/app/test_reports
72K	/app/test_result.md
4.0K	/app/tests
8.0K	/app/three_flows_test.log
4.0K	/app/yarn.lock
12K	/app/zip_regression_test.py
4.0K	/app/zip_test.log để xác định thư mục nào đang chiếm nhiều dung lượng nhất.
        - Cân nhắc thêm một bước dọn dẹp (cleanup) vào quy trình build.
     - Why to solve this issue and what will be achieved with this? Ngăn chặn việc build hoặc chạy ứng dụng thất bại trong tương lai do hết dung lượng disk.
     - Should Test frontend/backend/both after fix: NA
     - Is recurring issue? Y

**Known issue recurrence from previous fork**
  - Không có. Lỗi crash renderer là một vấne đề mới và nghiêm trọng hơn các vấn đề về hiệu suất trước đó.

**Code Architecture**


**Key Technical Concepts**
-   **Electron**: Framework xây dựng ứng dụng desktop.
-   **React**: Thư viện JavaScript xây dựng giao diện người dùng.
-   **Python**: Backend xử lý logic OCR và AI.
-   **Gemini Flash API**: Model AI của Google cho OCR và phân loại.
-   **IPC (Inter-Process Communication)**: Giao tiếp giữa main process và renderer process của Electron.
-   **electron-store**: Lưu trữ cấu hình và trạng thái quét local dưới dạng file JSON.

**key DB schema**
Ứng dụng không dùng DB quan hệ. Dữ liệu được lưu local bằng :
  - : Lưu cấu hình người dùng (OCR engine, batch mode, theme, etc.).
  - : Lưu trạng thái của các lần quét chưa hoàn tất để có thể resume.

**changes in tech stack**
  - Không có.

**All files**
- **Files đã chỉnh sửa nhiều trong phiên này:**
  - : Sửa rất nhiều lỗi liên quan đến resume, gộp PDF, sắp xếp GCN, và là nơi chứa lỗi crash hiện tại.
  - : Thiết kế lại UI, sửa lỗi sắp xếp GCN.
  - : Sửa logic chuyển tab khi resume.
  - : Thêm setting cho Smart Batch Size.
  - : Thêm tùy chọn  cho smart mode, thêm retry cho lỗi 500.
  - : Truyền setting  xuống script Python.
- **Files tài liệu đã tạo:**
  - 
  - 
  - 
  - 

**Areas that need refactoring**:
- : Cần refactor ngay lập tức logic render các tab thư mục con để implement lazy rendering, giải quyết lỗi crash. Toàn bộ cơ chế xử lý ảnh base64 là một điểm nghẽn hiệu năng và nên được xem xét lại trong tương lai (ví dụ: sử dụng  protocol hoặc một giải pháp virtualized list).

**key api endpoints**
Đây là ứng dụng desktop, sử dụng IPC của Electron thay vì API endpoint:
- : Kênh chính để gọi các script xử lý Python từ React.
- , , , : Quản lý trạng thái quét để resume.
- : Lấy ảnh preview (đây là một trong những nguyên nhân gây quá tải bộ nhớ).
- , : Quản lý cấu hình ứng dụng.

**Critical Info for New Agent**
- **Lỗi Quan trọng nhất:** Lỗi  là ưu tiên hàng đầu. Nguyên nhân đã được xác định là do render tất cả các tab ẩn cùng lúc. Giải pháp là implement **lazy rendering** trong .
- **Chờ Người dùng:** Người dùng cần đưa ra quyết định về việc tối ưu hóa prompt. Đừng implement cho đến khi có xác nhận.
- **Ngôn ngữ:** Toàn bộ giao tiếp với người dùng và văn bản trong UI phải bằng **tiếng Việt**.

**documents created in this job**
  - /app/desktop-app/TOKEN_CALCULATION.md
  - /app/desktop-app/PROMPT_OPTIMIZATION_PROPOSAL.md
  - /app/desktop-app/PROMPT_DETAILED_COMPARISON.md
  - /app/desktop-app/batch_scanner_mockup.html

**Last 5 User Messages and any pending user messages**
- **User (msg 471):** Báo cáo lỗi  vẫn xảy ra. (Chưa giải quyết)
- **Agent (msg 472-483):** Thử một Emergency Fix bằng cách giảm mạnh số lượng ảnh hiển thị và mặc định tắt preview. (Không hiệu quả)
- **User (msg 484):** Báo lỗi crash vẫn còn và **đưa ra chẩn đoán chính xác**: hiện tại đang tải tất cả các tad lên 1 lúc rồi mới hiển thị. nếu tải 1 tab xong hiển thị tab đó rồi tải tab tiếp theo có khả thi hơn không. (Chưa giải quyết)
- **Agent (msg 485):** Đồng ý với chẩn đoán của người dùng, xác nhận đó là nguyên nhân gốc rễ và tuyên bố giải pháp đúng là **Lazy Render**. (Đã lên kế hoạch)
- **Agent (msg 486-489):** Tìm và xác định chính xác đoạn code sai () trong  gây ra vấn đề. (Đã lên kế hoạch)

**Project Health Check:**
- **Broken:** Ứng dụng hiện đang không ổn định và không thể sử dụng cho các tác vụ lớn (quét thư mục có nhiều thư mục con) do lỗi renderer process crash.

**Testing status**
  - Testing agent used after significant changes: NO
  - Troubleshoot agent used after agent stuck in loop: NO
  - Test files created: []
  - Known regressions: Renderer process crash.

**Credentials to test flow:**
Không cần thiết.

**What agent forgot to execute**
- Kỹ sư AI đã không giải quyết cảnh báo  xuất hiện nhiều lần trong quá trình làm việc. Đây là một rủi ro tiềm tàng có thể gây gián đoạn trong tương lai.</analysis>
