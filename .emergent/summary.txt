<analysis>**original_problem_statement:**
Ban đầu, người dùng yêu cầu bỏ giới hạn kích thước tối thiểu (1500x2100) khi resize ảnh trong phần cài đặt để có thể điều chỉnh tự do. Sau đó, một loạt các yêu cầu và báo cáo lỗi đã được đưa ra và xử lý, bao gồm:
- Sửa lỗi 503 API bằng cách giảm chất lượng JPEG.
- Thêm tùy chọn bật/tắt tính năng sắp xếp tài liệu GCN lên đầu danh sách kết quả.
- Sửa lỗi logic sắp xếp GCN khiến tất cả bị phân loại là GCNM.
- Phát hiện và cảnh báo các thư mục trùng tên trong chế độ quét hàng loạt (Batch Scan) và quét thư mục (Folder Scan) để tránh gộp kết quả sai.
- Thêm tùy chọn bật/tắt tự động lưu phiên làm việc (Auto-save) để cải thiện hiệu năng trên máy cấu hình yếu.
- Gỡ bỏ phân trang (pagination) trong kết quả quét thư mục để hiển thị tất cả file cùng lúc.
- Thêm nút Next và Back ở cuối trang preview để chuyển tab mà không cần cuộn lên.
- Sửa lỗi văn bản trên các nút bật/tắt để hiển thị rõ trạng thái hiện tại (Đang bật / Đang tắt).
- Sửa lỗi nút Next/Back tự động cuộn lên đầu trang.
- Người dùng đề xuất và yêu cầu triển khai một chế độ OCR thử nghiệm mới: dùng Tesseract để OCR local, sau đó gửi text lên Gemini để phân loại nhằm tiết kiệm chi phí và tăng tốc độ.
- Sau khi triển khai, người dùng yêu cầu dọn dẹp và tối ưu các prompt gửi đến Gemini bằng cách xóa 32 mã tài liệu không sử dụng và loại bỏ các đoạn hướng dẫn bị trùng lặp.
- Yêu cầu cuối cùng là đồng bộ hóa prompt giữa hai phiên bản  và  để đảm bảo logic nhất quán, với phiên bản  là một bản rút gọn nhưng đầy đủ về mặt logic của bản .

**what currently exists?**
- Ứng dụng OCR 데스크톱 xây dựng bằng Electron, React và Python backend.
- Hỗ trợ các chế độ quét: File Scan, Folder Scan, và Batch Scan (từ file .txt).
- Sử dụng Gemini Flash Vision API làm engine OCR đám mây chính.
- Đã triển khai một chế độ OCR thử nghiệm mới () kết hợp Tesseract OCR local và Gemini Text API để phân loại. Chế độ này được tích hợp như một lựa chọn trong Cloud Settings.
- Giao diện người dùng có các tùy chọn để: điều chỉnh kích thước ảnh tự do, bật/tắt sắp xếp GCN, bật/tắt tự động lưu.
- Logic phát hiện thư mục trùng lặp đã được thêm vào cho cả chế độ quét thư mục và quét hàng loạt.
- Các prompt của Gemini đã được dọn dẹp đáng kể (xóa 32 mã, loại bỏ các phần trùng lặp) để giảm token và tăng tính nhất quán.

**Last working item**:
- **Last item agent was working**: Agent đang trong quá trình so sánh và đồng bộ hóa nội dung giữa hai prompt:  và  trong file . Mục tiêu là cập nhật bản lite để nó trở thành một phiên bản rút gọn nhưng vẫn đầy đủ về mặt logic và quy tắc so với bản full, vì agent đã phát hiện bản lite đang thiếu rất nhiều quy tắc quan trọng.
- **Status**: IN PROGRESS
- **Agent Testing Done**: N
- **Which testing method agent to use?**: Manual testing by user. Sau khi agent cập nhật prompt, người dùng cần được yêu cầu chọn engine Gemini Flash Lite, quét thử một vài loại tài liệu và xác nhận độ chính xác của việc phân loại có hợp lý và nhất quán không.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1 (P0)**: Đồng bộ hóa prompt của  với .
  - **Attempted fixes**: Agent đã bắt đầu phân tích và xác định được sự khác biệt lớn giữa hai prompt.
  - **Next debug checklist**:
    1.  Mở file .
    2.  So sánh một cách có hệ thống nội dung của hàm  với .
    3.  Sao chép các logic cốt lõi, quy tắc (ví dụ: phân biệt GCN Cũ/Mới, xử lý trang tiếp theo, quy trình kiểm tra) và các ví dụ đại diện từ prompt full sang prompt lite.
    4.  Đảm bảo prompt lite sau khi cập nhật là một phiên bản cô đọng nhưng tương đương về mặt chức năng so với prompt full.
  - **Why fix this issue and what will be achieved with the fix?**: Để đảm bảo người dùng khi chọn engine Lite (rẻ hơn) vẫn nhận được kết quả phân loại nhất quán và chính xác, tránh các hành vi khó đoán do prompt kém phát triển.
  - **Status**: IN PROGRESS
  - **Is recurring issue?**: N
  - **Should Test frontend/backend/both after fix?**: Backend (chất lượng phân loại), người dùng sẽ test thủ công.
  - **Blocked on other issue**: None.

- **Issue 2 (P2)**: Cảnh báo dung lượng ổ đĩa liên tục ở mức 95% ().
  - **Attempted fixes**: Chưa có.
  - **Next debug checklist**:
    1.  Dùng lệnh 0	/app/0.6
0	/app/=
8.0K	/app/BATCH_UPLOAD_SOLUTION.md
8.0K	/app/CLOUD_BOOST_COMPLETE.md
16K	/app/COST_OPTIMIZATION_ALTERNATIVES.md
8.0K	/app/DEPLOYMENT_FIXES_APPLIED.md
20K	/app/DESKTOP_APP_ARCHITECTURE.md
8.0K	/app/DESKTOP_APP_IMPLEMENTATION.md
8.0K	/app/DESKTOP_APP_PHASE1_COMPLETE.md
12K	/app/DESKTOP_APP_TESTING_CHECKLIST.md
4.0K	/app/EMERGENT_LLM_KEY_GUIDE.md
4.0K	/app/FIX_PDF_IMAGE_ERROR.md
8.0K	/app/PERFORMANCE_ANALYSIS.md
8.0K	/app/PRICING_GUIDE.md
8.0K	/app/RAILWAY_DEBUG_FAILED_FETCH.md
8.0K	/app/RAILWAY_DEBUG_INTERNAL_ERROR.md
8.0K	/app/RAILWAY_DEPLOYMENT_CHECKLIST.md
12K	/app/RAILWAY_DEPLOYMENT_GUIDE.md
8.0K	/app/RAILWAY_FIX_INTERNAL_SERVER_ERROR.md
4.0K	/app/RAILWAY_FIX_PIP_ERROR.md
8.0K	/app/RAILWAY_FIX_SUMMARY.md
8.0K	/app/RAILWAY_FRONTEND_VS_BACKEND_URL.md
12K	/app/RAILWAY_HUONG_DAN_TIENG_VIET.md
8.0K	/app/RAILWAY_NEXT_STEPS.md
8.0K	/app/RAILWAY_QUICK_START.md
24K	/app/RAILWAY_SO_DO.md
8.0K	/app/RAILWAY_TOM_TAT.md
8.0K	/app/RAILWAY_WRONG_LOGS.md
4.0K	/app/README.md
12K	/app/SEQUENTIAL_NAMING_COMPLETE.md
12K	/app/additional_folder_tests.py
4.0K	/app/auth_test.py
2.6G	/app/backend
12K	/app/backend_test.py
16K	/app/comprehensive_rule_validation_results.json
20K	/app/comprehensive_rule_validation_test.py
1.6G	/app/desktop-app
218M	/app/desktop-app.zip
16K	/app/desktop_ocr_validation_test.py
20K	/app/direct_folder_test.py
12K	/app/easyocr_direct_test.py
16K	/app/focused_backend_test.py
4.0K	/app/focused_desktop_validation_results.json
16K	/app/focused_desktop_validation_test.py
20K	/app/focused_test_three_flows.py
20K	/app/folder_scan_test.py
704M	/app/frontend
4.0K	/app/llm_health_output.log
16K	/app/llm_health_test.py
16K	/app/llm_integration_test.py
12K	/app/node_modules
4.0K	/app/package-lock.json
12K	/app/review_test.py
4.0K	/app/simple_llm_health_test.py
4.0K	/app/test_deployed.sh
8.0K	/app/test_reports
88K	/app/test_result.md
4.0K	/app/tests
8.0K	/app/three_flows_test.log
4.0K	/app/yarn.lock
12K	/app/zip_regression_test.py
4.0K	/app/zip_test.log để xác định thư mục nào đang chiếm nhiều dung lượng nhất.
    2.  Kiểm tra các file log lớn, dữ liệu cache của Electron, hoặc các kết quả quét cũ không được dọn dẹp.
  - **Why fix this issue and what will be achieved with the fix?**: Ổ đĩa đầy có thể gây sập ứng dụng, mất dữ liệu, hoặc ngăn ứng dụng khởi động và lưu các phiên quét mới.
  - **Status**: NOT STARTED
  - **Is recurring issue?**: Y
  - **Should Test frontend/backend/both after fix?**: Manual. Kiểm tra lại dung lượng ổ đĩa bằng Filesystem      Size  Used Avail Use% Mounted on
overlay          95G  6.2G   89G   7% /
tmpfs            64M     0   64M   0% /dev
/dev/nvme0n3    9.8G  9.3G  532M  95% /app
/dev/nvme0n1p1   95G  6.2G   89G   7% /etc/hosts
shm              64M     0   64M   0% /dev/shm
tmpfs           7.9G     0  7.9G   0% /proc/acpi
tmpfs           7.9G     0  7.9G   0% /proc/scsi
tmpfs           7.9G     0  7.9G   0% /sys/firmware sau khi dọn dẹp.
  - **Blocked on other issue**: None.

**In progress Task List**:
- Không có. Công việc hiện tại được phân loại là sửa lỗi (issue).

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
  - **(P1) Triển khai chế độ OCR Hybrid**: Kết hợp Tesseract cho các ảnh chất lượng cao và tự động fallback về Gemini Vision cho các ảnh chất lượng thấp. Ý tưởng này đã được thảo luận và là bước logic tiếp theo sau khi chế độ Tesseract+Text được xác nhận hoạt động tốt.
- **Future Tasks**:
  - Tinh chỉnh .
  - Thêm icon cho ứng dụng trên macOS.
  - Triển khai hệ thống license key.
  - Thêm cấu hình giá trong phần cài đặt.

**Completed work in this session**
- **Recently completed**:
  - Cho phép tùy chỉnh kích thước resize ảnh tự do trong Cài đặt ().
  - Giảm chất lượng JPEG xuống 85 để khắc phục lỗi 503 API ().
  - Thêm tùy chọn bật/tắt sắp xếp GCN lên đầu (, ).
  - Sửa lỗi logic phân loại GCN Cũ/Mới (, ).
  - Phát hiện và cảnh báo thư mục trùng lặp trong cả chế độ quét hàng loạt và quét thư mục (, ).
  - Thêm tùy chọn bật/tắt Auto-save trong Cài đặt (, , ).
  - Gỡ bỏ phân trang ở kết quả quét thư mục ().
  - Thêm nút Next/Back ở cuối trang preview để điều hướng tab (, ).
  - Sửa lỗi các nút bật/tắt hiển thị văn bản gây nhầm lẫn (, , ).
  - Sửa lỗi nút Next/Back tự động cuộn lên đầu trang.
  - **Triển khai chế độ OCR Tesseract+Text**: Tích hợp như một tùy chọn engine đám mây () và sửa các lỗi liên quan để đảm bảo nó hoạt động trong cả chế độ quét hàng loạt và quét tuần tự.
  - **Tối ưu Prompt Gemini**: Xóa 32 mã tài liệu không dùng và loại bỏ/hợp nhất các đoạn hướng dẫn bị trùng lặp trong .

**Earlier issues found/mentioned but not fixed**
- Đã được liệt kê trong **All Pending/In progress Issue list**.

**Known issue recurrence from previous fork**
- **Issue recurrence**: Lỗi  khi gọi API.
- **Recurrence count**: Cao.
- **Status**: MITIGATED. Lỗi đã được giảm thiểu bằng cách giảm chất lượng ảnh xuống 85 và giới thiệu chế độ Tesseract+Text như một giải pháp thay thế hiệu quả hơn. Vấn đề chưa được giải quyết triệt để vì vẫn có thể xảy ra ở chế độ Vision với batch lớn, nhưng đã có các biện pháp giảm thiểu quan trọng.

**Code Architecture**
Cấu trúc thư mục vẫn giữ nguyên như mô tả trong prompt hệ thống. Các file được chỉnh sửa nhiều nhất trong phiên này bao gồm:
- 
- 
- 
- 
- 
- 
- 
- 

**Key Technical Concepts**
- Electron, React, Python, , IPC.
- **Khái niệm mới**: Phương pháp OCR Hybrid (Tesseract local + LLM cloud) được giới thiệu như một chiến lược tối ưu hóa chi phí và hiệu suất.

**key DB schema**
- Không áp dụng, ứng dụng sử dụng  để lưu trạng thái vào file JSON.

**changes in tech stack**
- Không có thay đổi cơ bản nào về công nghệ.

**All files**
- : Được chỉnh sửa nhiều nhất để dọn dẹp và đồng bộ hóa các prompt cho Gemini.
-  & : Được chỉnh sửa nhiều để thêm các tính năng mới (toggles, nút điều hướng) và sửa lỗi.
-  & : Được chỉnh sửa để quản lý các cài đặt mới.
-  & : Được cập nhật để hỗ trợ chế độ OCR mới.
- : Cập nhật để truyền đúng chế độ OCR cho backend.

**Areas that need refactoring**:
- Logic prompt trong  hiện được chia sẻ giữa  và . Mặc dù công việc hiện tại là đồng bộ hóa chúng, một giải pháp dài hạn tốt hơn là xây dựng prompt từ các thành phần chung để tránh sự thiếu nhất quán trong tương lai.
- File  đã được tạo nhưng có thể đã trở nên thừa thãi sau khi logic của nó được tích hợp vào  và . Cần kiểm tra và có thể xóa bỏ file này.

**key api endpoints**
- Không có endpoint mới. Giao tiếp chủ yếu qua các kênh IPC của Electron, đặc biệt là .

**Critical Info for New Agent**
- Người dùng rất am hiểu kỹ thuật và đưa ra phản hồi cụ thể, chính xác.
- Hiện có hai luồng xử lý OCR chính: Vision (gửi ảnh đến Gemini) và Tesseract+Text (OCR local, gửi text đến Gemini). Agent cần nhận biết chế độ nào đang hoạt động khi debug.
- Các prompt của Gemini đã được tối ưu hóa nhiều. Bất kỳ thay đổi nào trong tương lai cần được thực hiện cẩn thận cho cả phiên bản lite và full để duy trì sự nhất quán.
- Cảnh báo  là một vấn đề dai dẳng, chưa được giải quyết và có thể trở nên nghiêm trọng.

**documents created in this job**
- : File hướng dẫn debug tạm thời, có thể không còn cần thiết.

**Last 5 User Messages and any pending user messages**
1.  **User**: Hỏi tại sao token đầu vào vẫn cao (11,788) sau khi đã tối ưu prompt.
2.  **User**: Yêu cầu tính toán chi phí cho một batch 5 ảnh giữa chế độ Vision và Tesseract+Text.
3.  **User**: Yêu cầu agent kiểm tra và đồng bộ hóa prompt của  và , cập nhật bản  để chi tiết và đầy đủ như bản .
4.  **Agent**: Gặp lỗi  khi bắt đầu so sánh prompt.
5.  **User**: tiếp tục - Yêu cầu agent tiếp tục công việc đang dang dở.

**Project Health Check:**
- **Broken**: Chức năng phân loại của chế độ  đang hoạt động kém hiệu quả do prompt chưa hoàn thiện, không nhất quán với chế độ .
- **Mocked**: Không có.

**Testing status**
- Testing agent used after significant changes: NO
- Troubleshoot agent used after agent stuck in loop: NO
- Test files created:
  - 
- Known regressions: None

**Credentials to test flow:**
- Không áp dụng.

**What agent forgot to execute**
- Agent chưa giải quyết cảnh báo  lặp đi lặp lại.
- Agent chưa xác minh liệu file  có còn được sử dụng hay đã trở thành code thừa.</analysis>
