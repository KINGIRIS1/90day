<analysis>
The previous AI engineer's work centered on the Batch Scan from List feature, an iterative process marked by continuous debugging and refinement. Initial challenges included Electron IPC, caching, and React state management, particularly for sequential naming and PDF merging. Much effort went into fixing persistent merge issues (custom folder output) and improving document classification accuracy by meticulously refining Gemini Flash Lite prompts. This involved distinguishing similar document types, strengthening GCN identification rules, addressing Flash Lite's limitations with text case distinction, and ensuring prompt stability. The trajectory concluded with a detailed analysis and strong recommendation for a user-proposed Two-Tier OCR approach, balancing cost and accuracy by using Flash Lite for easy cases and Flash Full for complex ones. The user approved implementing this as an optional setting.
</analysis>

<product_requirements>
The application is a desktop OCR scanner for Vietnamese land documents.
**General Requirements:** One-click installer, accurate document classification (e.g., HDTG as HDCQ, BVDS as HSKT, DXTHT, DDK as PCTSVC), optimized Gemini prompts (cost/accuracy), customizable UI/UX, and rate limit management.
**Batch Scan from List Feature (Primary Focus):**
*   **Input:** Read folder paths from a TXT file, scan only image files (JPG, JPEG, PNG); skip non-existent folders or those without images; no sub-folder scanning.
*   **Output Options:** Rename files in place; copy files by document type to a new sub-folder with a user-defined suffix; copy merged PDF files to a user-selected custom folder, organized by source folder names.
*   **Processing:** Merge images of the same type within a folder into a single PDF.
*   **UI/UX:** Batch Scan tab, 2-step flow (load then scan), progress bar/error logging, stop button, dynamic display of results (grid view with image previews), horizontal folder tabs with Merge button, Merge All Tabs button, image zoom, accurate OCR engine display (Cloud/Offline).
*   **Naming:** Sequential naming for UNKNOWN classified documents, reverting to the .
*   **Recent Refinements:** GCN date-based classification, robust GCN hard rules (national emblem), improved distinction for document types (HDCQ/HDUQ, PXNKQDD/PKTHS), and stable Gemini responses.
</product_requirements>

<key_technical_concepts>
-   **Electron**: Framework for building desktop applications.
-   **React**: JavaScript library for the frontend UI.
-   **Python**: Backend for OCR processing and AI classification.
-   **Gemini Flash API**: Google's AI models (Flash & Flash Lite) for OCR/classification, prompt engineering, .
-   **IPC (Inter-Process Communication)**: Electron's method for communication.
-   **Subprocess Module**: Python's way to run external scripts.
-   **PyPDF**: Python library for PDF creation.
-   **Image Processing**: Resizing, cropping images.
-   **Cascade Classifiers**: Two-tier OCR strategy for efficiency.
</key_technical_concepts>

<code_architecture>
The application has , , and  structures, with recent work focused on .

-   ****: Electron's main process, handles IPC.
    -   **Changes**: Fixed  to use  for  merge. Added extensive  statements and  for file writing/folder creation to debug merge issues.
-   ****: Exposes Node.js APIs to renderer.
    -   **Changes**: Added  to  to verify IPC communication for merge.
-   ****: React component for Batch Scan UI.
    -   **Changes**:
        -   Fixed sequential naming by changing  (state) to a local variable  for synchronous updates.
        -   Integrated  and  (copied from ) after folder scans.
        -   Ensured , ,  are copied to  for GCN post-processing.
        -   Refactored GCN pairing logic to group files by  before pairing, correcting date-based naming.
        -   Added  around  for robustness.
-   ****: Python script for Gemini OCR/classification, containing prompt definitions.
    -   **Changes**:
        -   Clarified HDCQ/HDUQ distinction in prompt with details and examples.
        -   Added  (, ) to Gemini API payload for stability.
        -   Strengthened GCN hard rules (national emblem, specific lines) in the prompt.
        -   Refined title position rules, blacklisting problematic patterns (e.g., Người lập văn bản cam kết...) instead of relying on unreliable uppercase detection.
        -   Strengthened title position rules for continuation pages (middle titles) with examples.
        -   Added distinguishing details and examples for PXNKQDD vs PKTHS.
        -   Modified  to 1500 and  to 2100 for image resizing.
-   ****: Source for  and  functions, which were then copied to .
-   **New Documentation/Test Files**: Various  and  files were created to document fixes, provide debug instructions, or add temporary tests.
</code_architecture>

<pending_tasks>
-   Implement full logic for the all-in-one installer.
-   Fine-tune remaining document types in  and .
-   Monitor OpenAI quota/plan for Emergent LLM Key.
-   Migrate or pin React/Webpack versions.
-   Update icon for macOS (.icns).
-   Implement license/activation key feature.
-   Implement Parallel Local Processing for batch scanning.
-   Handle deep path length issues.
-   Address slow app startup.
-   Add configurable single price rates in Cloud Settings.
-   Implement code patch for robust cache pathing and single-instance lock in .
-   Ensure the stop button is fully functional.
-   Implement the proposed Two-Tier OCR classification as an optional setting.
</pending_tasks>

<current_work>
Immediately prior to this summary, the AI engineer was deep into a discussion with the user about optimizing the OCR classification for both cost-efficiency and accuracy. The user proposed a Two-Tier classification strategy:
1.  **Tier 1 (Fast & Cheap):** Utilize Gemini Flash Lite to scan only the top portion of an image (e.g., 60%) using a simplified prompt for documents that are typically easy to classify (e.g., clear contracts or application forms).
2.  **Tier 2 (Thorough & Expensive):** For more complex documents (like GCNs requiring date extraction) or cases where Tier 1 provides low confidence, escalate to using the full Gemini Flash model on the entire image with the comprehensive set of 98 classification rules.

The AI engineer provided a detailed analysis comparing this Two-Tier approach against the existing Flash Lite-only method and a Flash Full-only method, evaluating accuracy, processing speed, and API costs, including an estimation of manual correction labor costs. The analysis concluded that the Two-Tier (60% crop) approach offered the best balance, significantly boosting overall accuracy (from ~82% to ~92%) at a comparable API cost to Flash Lite-only, leading to substantial savings when factoring in reduced manual error correction. The user accepted this recommendation and requested its implementation as an optional feature in the settings to ensure backward compatibility and prevent disruption to current functionality.
</current_work>

<optional_next_step>
Implement the Two-Tier OCR classification as an optional setting in the CloudSettings UI.
</optional_next_step>
