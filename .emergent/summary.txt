<analysis>**original_problem_statement:**
Ban đầu, người dùng yêu cầu sửa lỗi phân loại tài liệu của engine OCR, tối ưu hóa giao diện người dùng và cải thiện hiệu suất.

Các yêu cầu mới trong phiên làm việc này bao gồm:
1.  **Thay đổi logic Smart Mode**: Giảm số lượng file tối thiểu để kích hoạt từ 3 xuống 2.
2.  **Cải thiện trải nghiệm người dùng (UX)**:
    *   Khôi phục lại chức năng tự động hiển thị preview khi quét thư mục, loại bỏ nút Load Preview.
    *   Thêm thông báo lỗi chi tiết và thân thiện hơn cho người dùng khi API gặp sự cố (503, 429, etc.).
    *   Xóa các nút điều hướng (Prev, Next) bị trùng lặp ở cuối danh sách kết quả.
    *   Hiển thị trạng thái chi tiết hơn trong quá trình quét để người dùng biết app đang làm gì.
3.  **Thêm chức năng mới Only GCN**:
    *   Tạo một tab mới chỉ để xử lý GCN.
    *   Chức năng này sẽ quét các thư mục, sử dụng bộ lọc màu và khổ giấy () để xác định các file có khả năng là GCN.
    *   Chỉ gửi các file ứng viên GCN này qua API OCR để tiết kiệm chi phí.
    *   Các file còn lại sẽ được tự động đặt tên là GTLQ và giữ nguyên thứ tự ban đầu.
    *   Xử lý các thư mục một cách tuần tự thay vì xử lý tất cả file cùng lúc.
4.  **Sửa lỗi**:
    *   Khắc phục lỗi format response của Gemini API trong chế độ batch.
    *   Giải quyết các vấn đề môi trường cục bộ của người dùng (lỗi build, cache Electron, không pull code mới).
    *   Sửa lỗi  không nhận diện được GCN.

**User's preferred language**: Vietnamese

**what currently exists?**
- Một ứng dụng OCR desktop (Electron, React, Python) với nhiều chế độ quét.
- Hệ thống xử lý lỗi tập trung đã được triển khai cho cả frontend và backend để hiển thị các thông báo lỗi API thân thiện hơn.
- Vấn đề dung lượng ổ đĩa đã được giải quyết bằng cách xóa các file tạm.
- Logic Smart Mode đã được cập nhật để cho phép xử lý với 2 file thay vì 3.
- Giao diện người dùng đã được dọn dẹp (xóa các nút trùng lặp, khôi phục preview tự động).
- Một tab chức năng mới, **Only GCN**, đã được tạo (). Tab này có giao diện để chọn thư mục hoặc danh sách file, xử lý tuần tự từng thư mục và hiển thị trạng thái chi tiết.
- Logic pre-filter (bộ lọc sơ bộ) để nhận diện GCN dựa trên màu sắc () đã được tích hợp vào tab Only GCN.
- Các file cấu hình và thực thi của Electron (, ) đã được cập nhật để thêm các API cần thiết cho tab Only GCN.
- Đã tạo tài liệu  để ghi nhớ cấu trúc file quan trọng của Electron nhằm tránh lỗi trong tương lai.

**Last working item**:
- **Last item agent was working**: Người dùng báo cáo rằng tab Only GCN không nhận diện được các file GCN mặc dù chúng có tồn tại trong thư mục. Agent đã xác định nguyên nhân là do script  có các ngưỡng nhận diện màu sắc quá khắt khe. Agent đã bắt đầu sửa lỗi này bằng cách nới lỏng các ngưỡng trong  và thêm một tùy chọn (toggle switch) vào giao diện người dùng của  để cho phép người dùng bật/tắt chức năng pre-filter này.
- **Status**: IN PROGRESS
- **Agent Testing Done**: N
- **Which testing method agent to use?**: Manual testing by user. Người dùng cần pull code mới, rebuild và kiểm tra xem: 1. Các file GCN có được nhận diện chính xác hơn không. 2. Nút bật/tắt pre-filter có hoạt động như mong đợi không.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1 (P0)**:  nhận diện sai GCN.
- **Issue 2 (P1)**: Lỗi phân loại không nhất quán của engine .
- **Issue 3 (P2)**: Môi trường local của người dùng không đồng bộ, gây ra lỗi.
- **Issue 4 (P3)**: Cho phép sửa kết quả ngay khi quét xong từng file.

**Issues Detail:**
- **Issue 1:  nhận diện sai GCN**
  - **Attempted fixes**: Agent đã xác định rằng các ngưỡng  và các điều kiện màu sắc khác trong  là quá nghiêm ngặt, dẫn đến việc bỏ sót các file GCN có màu nhạt. Agent đã bắt đầu chỉnh sửa file này để nới lỏng các ngưỡng ( in message 488) và đồng thời thêm một state  và một toggle switch vào  để người dùng có thể tự quyết định sử dụng bộ lọc hay không ( in messages 481 & 483).
  - **Next debug checklist**:
    1.  Hoàn thành việc thêm UI toggle switch vào .
    2.  Xác nhận logic trong  sử dụng đúng state  để bỏ qua bước  khi toggle được tắt.
    3.  Yêu cầu người dùng kiểm tra với cả hai chế độ (bật và tắt pre-filter) để xem GCN có được nhận diện đúng không.
  - **Why fix this issue and what will be achieved with the fix?**: Đây là lỗi chặn (blocker) đối với chức năng cốt lõi của tab Only GCN. Sửa lỗi này sẽ làm cho tính năng hoạt động như mong đợi.
  - **Status**: IN PROGRESS
  - **Is recurring issue?**: N
  - **Should Test frontend/backend/both after fix?**: Both.
  - **Blocked on other issue**: None.

- **Issue 2: Lỗi phân loại không nhất quán của **
  - **Attempted fixes**: Agent đã thêm logic fallback vào  để xử lý trường hợp API trả về sai định dạng JSON. Tuy nhiên, vấn đề cốt lõi về độ chính xác của phân loại vẫn còn.
  - **Next debug checklist**:
    1.  Sau khi Issue 1 được giải quyết, tiếp tục theo dõi phản hồi của người dùng về các trường hợp phân loại sai.
    2.  Xem xét lại việc triển khai đầy đủ giải pháp trong  như một giải pháp dài hạn.
  - **Why fix this issue and what will be achieved with the fix?**: Cải thiện độ tin cậy của chức năng cốt lõi của ứng dụng.
  - **Status**: IN PROGRESS
  - **Is recurring issue?**: Y
  - **Should Test frontend/backend/both after fix?**: Backend (logic Python).
  - **Blocked on other issue**: Issue 1.

- **Issue 3: Môi trường local của người dùng không đồng bộ**
  - **Attempted fixes**: Agent đã mất rất nhiều thời gian để chẩn đoán các lỗi do người dùng chưa , chạy sai lệnh (yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command. thay vì yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.), hoặc bị lỗi cache Electron. Agent đã tạo ra các file hướng dẫn (, ) và liên tục hướng dẫn người dùng quy trình đúng.
  - **Next debug checklist**: Mỗi khi có thay đổi liên quan đến file Electron (, ), cần phải hướng dẫn người dùng một cách rõ ràng và chi tiết quy trình: , xóa cache Electron, và restart hoàn toàn app.
  - **Why fix this issue and what will be achieved with the fix?**: Giảm thời gian gỡ lỗi các vấn đề không liên quan đến code và tăng tốc độ phát triển.
  - **Status**: NOT STARTED (Đây là vấn đề về quy trình, không phải lỗi code để sửa).
  - **Is recurring issue?**: Y
  - **Should Test frontend/backend/both after fix?**: NA.
  - **Blocked on other issue**: None.

- **Issue 4: Cho phép sửa kết quả ngay khi quét xong file (edit-while-scanning)**
  - **Attempted fixes**: Chưa có. Đây là yêu cầu từ fork trước.
  - **Next debug checklist**:
    1.  Xác định các thành phần UI bị vô hiệu hóa bởi  trong  và .
    2.  Thay đổi điều kiện  từ một biến trạng thái chung thành kiểm tra trạng thái của từng mục riêng lẻ.
  - **Why fix this issue and what will be achieved with the fix?**: Cải thiện trải nghiệm người dùng, cho phép họ làm việc song song.
  - **Status**: NOT STARTED
  - **Is recurring issue?**: N
  - **Should Test frontend/backend/both after fix?**: Frontend.
  - **Blocked on other issue**: None.

**In progress Task List**:
- **Task 1: Hoàn thiện chức năng tab Only GCN (P0)**
  - **Where to resume**: Hoàn thành việc thêm toggle switch để bật/tắt pre-filter trong  và đảm bảo logic hoạt động đúng.
  - **What will be achieved with this?**: Một chức năng hoàn chỉnh cho phép người dùng quét GCN một cách hiệu quả và tiết kiệm chi phí, giải quyết được blocker hiện tại.
  - **Status**: IN PROGRESS
  - **Should Test frontend/backend/both after fix?**: Both.
  - **Blocked on something**: Issue 1.

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
  - **(P1)** Triển khai chế độ OCR Hybrid: Tự động sử dụng Tesseract cho ảnh chất lượng cao và fallback về Vision API.
  - **(P2)** Tinh chỉnh  dựa trên các lỗi phân loại mới.
- **Future Tasks**:
  - Thêm icon cho ứng dụng trên macOS.
  - Triển khai hệ thống license key.
  - Thêm cấu hình giá trong phần Cài đặt.

**Completed work in this session**
- **System Maintenance**:
  - Giải quyết cảnh báo ổ đĩa 95% bằng cách xóa thư mục .
- **Feature Enhancement & UI/UX**:
  - Giảm số file tối thiểu cho Smart Mode từ 3 xuống 2.
  - Khôi phục chế độ xem trước tự động cho quét thư mục.
  - Xóa các nút điều hướng (pagination) bị trùng lặp ở cuối trang.
  - Thêm hiển thị trạng thái xử lý chi tiết (VD: Pre-filtering..., Scanning..., Merging...) trong tab Only GCN.
- **Error Handling & Bug Fixing**:
  - Triển khai hệ thống xử lý lỗi tập trung (, ) để hiển thị thông báo thân thiện cho các lỗi API (503, 429, etc).
  - Sửa lỗi Gemini API trả về sai định dạng JSON trong chế độ batch.
  - Phát hiện và sửa lỗi nghiêm trọng về cấu trúc file Electron: các thay đổi phải được thực hiện trong  và  thay vì .
- **New Feature: Only GCN Tab**:
  - Tạo component  và thêm tab mới vào .
  - Triển khai luồng xử lý tuần tự cho từng thư mục.
  - Thêm các IPC handler và API cần thiết (, , ) vào  và .
- **Documentation**:
  - Tạo file  để hướng dẫn bảo trì hệ thống lỗi.
  - Tạo file  để ghi nhớ cấu trúc file Electron.
  - Tạo file batch  để giúp người dùng sửa lỗi môi trường local.

**Earlier issues found/mentioned but not fixed**
- Toàn bộ đã được liệt kê trong **All Pending/In progress Issue list**.

**Known issue recurrence from previous fork**
- **Issue recurrence**: Lỗi phân loại tài liệu không chính xác và không nhất quán.
- **Recurrence count**: Rất cao.
- **Status**: IN PROGRESS.

**Code Architecture**
- **Frontend**: React
  - : Component chính, quản lý các tab.
  - : (Mới) Logic cho tab Only GCN.
  - : Logic cho chế độ Batch.
  - : Logic cho chế độ File/Folder.
  - : (Mới) Cấu hình và xử lý lỗi phía frontend.
- **Backend**: Python
  - : Xử lý OCR cho từng file.
  - : Xử lý OCR cho chế độ Smart Batch.
  - : Script pre-filter để nhận diện GCN.
  - : (Mới) Cấu hình và xử lý lỗi phía backend.
- **Main Process**: Electron
  - : **File thực thi chính của Electron.** Nơi đăng ký IPC Handlers.
  - : **File preload chính của Electron.** Nơi expose API cho renderer process.
  - : Thư mục chứa code nguồn cho Electron, nhưng không phải là nơi được thực thi trực tiếp trong môi trường dev. **Đây là nguồn gây nhầm lẫn và lỗi.**

**Key Technical Concepts**
- **Electron Main vs Renderer Process**: Hiểu rõ  (main process) và  (bridge) là rất quan trọng. **Phát hiện quan trọng nhất của phiên này là app đang chạy các file trong  chứ không phải **.
- **Local Environment Desync**: Vấn đề lặp đi lặp lại khi môi trường local của người dùng không đồng bộ với code trên server. Cần có quy trình hướng dẫn rõ ràng (pull code, xóa cache, restart) cho người dùng mỗi khi có thay đổi quan trọng.
- **Defensive Programming**: Thêm các câu lệnh  trước khi gọi API để tránh crash app khi môi trường người dùng chưa được cập nhật.
- **IPC (Inter-Process Communication)**: Giao tiếp giữa React (renderer) và Electron (main) thông qua  và .

**key DB schema**
- Không có, ứng dụng sử dụng  để lưu trữ cài đặt.

**changes in tech stack**
- Không có.

**All files**
- : (Mới) Component chính cho chức năng mới.
- : (Cập nhật) Thêm các IPC handlers cho chức năng Only GCN.
- : (Cập nhật) Expose các API mới cho chức năng Only GCN.
- : (Cập nhật) Nới lỏng ngưỡng nhận diện màu.
- : (Mới) Module xử lý lỗi tập trung phía backend.
- : (Mới) Module xử lý lỗi tập trung phía frontend.
- : (Cập nhật) Thêm tab Only GCN.
- : (Cập nhật) Tích hợp  và sửa lỗi JSON parsing.
- : (Cập nhật) Dọn dẹp UI, tích hợp .
- : (Cập nhật) Khôi phục preview, tích hợp .
- : (Cập nhật) Sửa  value của slider.
- : (Mới) Tài liệu ghi chú về cấu trúc file Electron.
- : (Mới) Tài liệu hướng dẫn bảo trì hệ thống lỗi.
- : (Mới) Script giúp người dùng sửa lỗi môi trường.

**Areas that need refactoring**:
- Cấu trúc file của Electron đang gây nhầm lẫn. Có cả thư mục  và , . Cần thống nhất lại một nguồn code duy nhất (ví dụ: ) và có một bước build để sao chép các file cần thiết sang thư mục  để tránh lỗi code đã sửa nhưng không chạy.

**key api endpoints**
- **IPC Handlers (trong )**:
  - 
  - 
  - 

**Critical Info for New Agent**
- **QUAN TRỌNG NHẤT**: Luồng phát triển bắt buộc phải tuân theo: **Code trên server -> Người dùng Save to GitHub -> Người dùng  trên máy -> Người dùng restart hoàn toàn app**. Rất nhiều lỗi phát sinh do người dùng không làm đúng quy trình này.
- **CẤU TRÚC ELECTRON**: App đang thực thi các file trong thư mục  (, ). Mọi thay đổi liên quan đến Electron (thêm API, IPC handler) phải được áp dụng cho các file trong thư mục . Agent trước đã mắc sai lầm khi sửa file trong thư mục  và gây ra lỗi . Hãy đọc file .
- **LỆNH START APP**: Người dùng chạy app trên Windows bằng lệnh yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command., không phải yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command..
- **VẤN ĐỀ HIỆN TẠI**:  đang là blocker cho chức năng Only GCN. Cần hoàn thiện việc sửa lỗi và thêm toggle bật/tắt pre-filter.
- **SẴN SÀNG HƯỚNG DẪN DEBUG MÔI TRƯỜNG**: Hãy chuẩn bị tinh thần hướng dẫn người dùng xóa cache Electron (), kill process (), và restart app khi họ báo lỗi không thấy thay đổi.

**documents created in this job**
- 
- 
- 

**Last 5 User Messages and any pending user messages**
1.  **User**: Thêm nút tìm kiếm thư mục giống bên batch mode. (COMPLETED)
2.  **User**: Hiển thị rõ quy trình app đang làm việc để người dùng biết. (COMPLETED)
3.  **User**: Hiện tại app đang pre-filter toàn bộ số file. Giờ chỉ pre-filter theo thư mục và xử lý tuần tự. (COMPLETED)
4.  **User**: Kiểm tra lại. Rõ ràng trong thư mục có GCN nhưng không phân loại được. (PENDING - Đây là 
wtmp begins Mon Nov 17 09:13:30 2025)
5.  **User**: Ý tôi là app đang pre-filter GCN nhưng không nhận diện được các GCN. (PENDING - User làm rõ 
wtmp begins Mon Nov 17 09:13:30 2025)

**Project Health Check:**
- **Broken**:
  - Chức năng pre-filter của  không đáng tin cậy, đang chặn tính năng Only GCN.
  - Quy trình làm việc giữa môi trường dev (server) và môi trường của người dùng (local Windows) rất mong manh và thường xuyên gây lỗi.
- **Mocked**: Không có.

**Testing status**
- Testing agent used after significant changes: NO
- Troubleshoot agent used after agent stuck in loop: NO
- Test files created: None
- Known regressions: Không có.

**Credentials to test flow:**
N/A

**What agent forgot to execute**
- Agent đã phát hiện ra vấn đề cấu trúc file Electron ( vs ) nhưng chỉ sửa lỗi cục bộ (copy code sang ) mà chưa thực hiện refactor để thống nhất về một nguồn duy nhất. Điều này để lại rủi ro kỹ thuật cho agent tiếp theo.
- Agent đã nới lỏng ngưỡng trong  nhưng chưa hoàn thành việc thêm toggle UI để người dùng có thể tắt hoàn toàn pre-filter, mặc dù đã bắt đầu làm.</analysis>
